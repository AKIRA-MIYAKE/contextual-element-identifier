"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.joinConditionsByOr = exports.joinConditionsByAnd = exports.buildRoleCondition = exports.buildPositionCondition = exports.buildIdCondition = exports.buildCondition = exports.buildClassNameCondition = exports.buidlNodeName = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _interfaces = require("../identifier/interfaces");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

// eslint-disable-next-line @typescript-eslint/no-var-requires
var With = require('xpather').With; // eslint-disable-next-line @typescript-eslint/no-var-requires


var Condition = require('xpather/built/condition').Condition;

var buidlNodeName = function buidlNodeName(fragment) {
  var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

  var opts = _objectSpread({
    id: false
  }, options);

  return opts.id && typeof fragment.id !== 'undefined' ? '*' : fragment.nodeName;
};

exports.buidlNodeName = buidlNodeName;

var buildCondition = function buildCondition(fragment) {
  var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

  var opts = _objectSpread({
    id: false,
    className: false,
    role: false,
    strict: true,
    ignoreUniqueKey: false
  }, options);

  var idCondition = buildIdCondition(fragment, opts);
  var classNameConditions = buildClassNameCondition(fragment, opts);
  var roleConditions = buildRoleCondition(fragment, opts);
  var positionCondition = buildPositionCondition(fragment, opts);

  var conditionArray = _lodash.default.compact([idCondition, classNameConditions, roleConditions, positionCondition]);

  var conditions = conditionArray.length > 0 ? opts.strict ? joinConditionsByAnd(conditionArray) : joinConditionsByOr(conditionArray) : undefined;
  return conditions;
};

exports.buildCondition = buildCondition;

var buildIdCondition = function buildIdCondition(fragment, options) {
  if (options.ignoreUniqueKey && options.id && typeof fragment.id !== 'undefined') {
    return With.exactId(fragment.id);
  } else {
    return undefined;
  }
};

exports.buildIdCondition = buildIdCondition;

var buildClassNameCondition = function buildClassNameCondition(fragment, options) {
  if (!options.ignoreUniqueKey && fragment.uniqueKey === _interfaces.UniqueKey.ClassName && fragment.classNames.length > 0 || options.className && fragment.classNames.length > 0) {
    var arr = fragment.classNames.map(function (cn) {
      return With.attribute('class', cn);
    });
    return options.strict ? joinConditionsByAnd(arr) : joinConditionsByOr(arr);
  } else {
    return undefined;
  }
};

exports.buildClassNameCondition = buildClassNameCondition;

var buildRoleCondition = function buildRoleCondition(fragment, options) {
  if (!options.ignoreUniqueKey && fragment.uniqueKey === _interfaces.UniqueKey.Role && fragment.roles.length > 0 || options.role && fragment.roles.length > 0) {
    var arr = fragment.roles.map(function (r) {
      return With.attribute('role', r);
    });
    return options.strict ? joinConditionsByAnd(arr) : joinConditionsByOr(arr);
  } else {
    return undefined;
  }
};

exports.buildRoleCondition = buildRoleCondition;

var buildPositionCondition = function buildPositionCondition(fragment, options) {
  if (!options.ignoreUniqueKey) {
    if (fragment.uniqueKey === _interfaces.UniqueKey.Index && fragment.hasSiblings && fragment.index + 1) {
      return With.position(fragment.index + 1);
    } else {
      return undefined;
    }
  } else {
    if (!fragment.hasSiblings || fragment.index === -1) {
      return undefined;
    }

    if (options.id && typeof fragment.id !== 'undefined') {
      return undefined;
    }

    if (options.className && fragment.classNames.length > 0 || options.role && fragment.roles.length > 0) {
      return new Condition("position() = ".concat(fragment.index + 1));
    } else {
      return With.position(fragment.index + 1);
    }
  }
}; // eslint-disable-next-line @typescript-eslint/no-explicit-any


exports.buildPositionCondition = buildPositionCondition;

var joinConditionsByAnd = function joinConditionsByAnd(conditions) {
  return conditions.reduce(function (acc, current) {
    return acc.and(current);
  });
}; // eslint-disable-next-line @typescript-eslint/no-explicit-any


exports.joinConditionsByAnd = joinConditionsByAnd;

var joinConditionsByOr = function joinConditionsByOr(conditions) {
  return conditions.reduce(function (acc, current) {
    return acc.or(current);
  });
};

exports.joinConditionsByOr = joinConditionsByOr;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy94cGF0aC9idWlsZGVyLnRzIl0sIm5hbWVzIjpbIldpdGgiLCJyZXF1aXJlIiwiQ29uZGl0aW9uIiwiYnVpZGxOb2RlTmFtZSIsImZyYWdtZW50Iiwib3B0aW9ucyIsIm9wdHMiLCJpZCIsIm5vZGVOYW1lIiwiYnVpbGRDb25kaXRpb24iLCJjbGFzc05hbWUiLCJyb2xlIiwic3RyaWN0IiwiaWdub3JlVW5pcXVlS2V5IiwiaWRDb25kaXRpb24iLCJidWlsZElkQ29uZGl0aW9uIiwiY2xhc3NOYW1lQ29uZGl0aW9ucyIsImJ1aWxkQ2xhc3NOYW1lQ29uZGl0aW9uIiwicm9sZUNvbmRpdGlvbnMiLCJidWlsZFJvbGVDb25kaXRpb24iLCJwb3NpdGlvbkNvbmRpdGlvbiIsImJ1aWxkUG9zaXRpb25Db25kaXRpb24iLCJjb25kaXRpb25BcnJheSIsIl8iLCJjb21wYWN0IiwiY29uZGl0aW9ucyIsImxlbmd0aCIsImpvaW5Db25kaXRpb25zQnlBbmQiLCJqb2luQ29uZGl0aW9uc0J5T3IiLCJ1bmRlZmluZWQiLCJleGFjdElkIiwidW5pcXVlS2V5IiwiVW5pcXVlS2V5IiwiQ2xhc3NOYW1lIiwiY2xhc3NOYW1lcyIsImFyciIsIm1hcCIsImNuIiwiYXR0cmlidXRlIiwiUm9sZSIsInJvbGVzIiwiciIsIkluZGV4IiwiaGFzU2libGluZ3MiLCJpbmRleCIsInBvc2l0aW9uIiwicmVkdWNlIiwiYWNjIiwiY3VycmVudCIsImFuZCIsIm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBRUE7Ozs7Ozs7Ozs7QUFFQTtBQUNBLElBQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLFNBQUQsQ0FBUCxDQUFtQkQsSUFBaEMsQyxDQUNBOzs7QUFDQSxJQUFNRSxTQUFTLEdBQUdELE9BQU8sQ0FBQyx5QkFBRCxDQUFQLENBQW1DQyxTQUFyRDs7QUFrQk8sSUFBTUMsYUFBYSxHQUFHLFNBQWhCQSxhQUFnQixDQUMzQkMsUUFEMkIsRUFHaEI7QUFBQSxNQURY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cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuaW1wb3J0IHsgRWxlbWVudEZyYWdtZW50LCBVbmlxdWVLZXkgfSBmcm9tICcuLi9pZGVudGlmaWVyL2ludGVyZmFjZXMnO1xuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXZhci1yZXF1aXJlc1xuY29uc3QgV2l0aCA9IHJlcXVpcmUoJ3hwYXRoZXInKS5XaXRoO1xuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby12YXItcmVxdWlyZXNcbmNvbnN0IENvbmRpdGlvbiA9IHJlcXVpcmUoJ3hwYXRoZXIvYnVpbHQvY29uZGl0aW9uJykuQ29uZGl0aW9uO1xuXG5leHBvcnQgaW50ZXJmYWNlIFhQYXRoT3B0aW9ucyB7XG4gIGlkPzogYm9vbGVhbjtcbiAgY2xhc3NOYW1lPzogYm9vbGVhbjtcbiAgcm9sZT86IGJvb2xlYW47XG4gIHN0cmljdD86IGJvb2xlYW47XG4gIGlnbm9yZVVuaXF1ZUtleT86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgWFBhdGhJbm5lck9wdGlvbnMge1xuICBpZDogYm9vbGVhbjtcbiAgY2xhc3NOYW1lOiBib29sZWFuO1xuICByb2xlOiBib29sZWFuO1xuICBzdHJpY3Q6IGJvb2xlYW47XG4gIGlnbm9yZVVuaXF1ZUtleTogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNvbnN0IGJ1aWRsTm9kZU5hbWUgPSAoXG4gIGZyYWdtZW50OiBFbGVtZW50RnJhZ21lbnQsXG4gIG9wdGlvbnM6IFhQYXRoT3B0aW9ucyA9IHt9XG4pOiBzdHJpbmcgPT4ge1xuICBjb25zdCBvcHRzID0ge1xuICAgIGlkOiBmYWxzZSxcbiAgICAuLi5vcHRpb25zLFxuICB9O1xuXG4gIHJldHVybiBvcHRzLmlkICYmIHR5cGVvZiBmcmFnbWVudC5pZCAhPT0gJ3VuZGVmaW5lZCdcbiAgICA/ICcqJ1xuICAgIDogZnJhZ21lbnQubm9kZU5hbWU7XG59O1xuXG5leHBvcnQgY29uc3QgYnVpbGRDb25kaXRpb24gPSAoXG4gIGZyYWdtZW50OiBFbGVtZW50RnJhZ21lbnQsXG4gIG9wdGlvbnM6IFhQYXRoT3B0aW9ucyA9IHt9XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4pOiBhbnkgPT4ge1xuICBjb25zdCBvcHRzID0ge1xuICAgIGlkOiBmYWxzZSxcbiAgICBjbGFzc05hbWU6IGZhbHNlLFxuICAgIHJvbGU6IGZhbHNlLFxuICAgIHN0cmljdDogdHJ1ZSxcbiAgICBpZ25vcmVVbmlxdWVLZXk6IGZhbHNlLFxuICAgIC4uLm9wdGlvbnMsXG4gIH07XG5cbiAgY29uc3QgaWRDb25kaXRpb24gPSBidWlsZElkQ29uZGl0aW9uKGZyYWdtZW50LCBvcHRzKTtcbiAgY29uc3QgY2xhc3NOYW1lQ29uZGl0aW9ucyA9IGJ1aWxkQ2xhc3NOYW1lQ29uZGl0aW9uKGZyYWdtZW50LCBvcHRzKTtcbiAgY29uc3Qgcm9sZUNvbmRpdGlvbnMgPSBidWlsZFJvbGVDb25kaXRpb24oZnJhZ21lbnQsIG9wdHMpO1xuICBjb25zdCBwb3NpdGlvbkNvbmRpdGlvbiA9IGJ1aWxkUG9zaXRpb25Db25kaXRpb24oZnJhZ21lbnQsIG9wdHMpO1xuXG4gIGNvbnN0IGNvbmRpdGlvbkFycmF5ID0gXy5jb21wYWN0KFtcbiAgICBpZENvbmRpdGlvbixcbiAgICBjbGFzc05hbWVDb25kaXRpb25zLFxuICAgIHJvbGVDb25kaXRpb25zLFxuICAgIHBvc2l0aW9uQ29uZGl0aW9uLFxuICBdKTtcblxuICBjb25zdCBjb25kaXRpb25zID1cbiAgICBjb25kaXRpb25BcnJheS5sZW5ndGggPiAwXG4gICAgICA/IG9wdHMuc3RyaWN0XG4gICAgICAgID8gam9pbkNvbmRpdGlvbnNCeUFuZChjb25kaXRpb25BcnJheSlcbiAgICAgICAgOiBqb2luQ29uZGl0aW9uc0J5T3IoY29uZGl0aW9uQXJyYXkpXG4gICAgICA6IHVuZGVmaW5lZDtcblxuICByZXR1cm4gY29uZGl0aW9ucztcbn07XG5cbmV4cG9ydCBjb25zdCBidWlsZElkQ29uZGl0aW9uID0gKFxuICBmcmFnbWVudDogRWxlbWVudEZyYWdtZW50LFxuICBvcHRpb25zOiBYUGF0aElubmVyT3B0aW9uc1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuKTogYW55ID0+IHtcbiAgaWYgKFxuICAgIG9wdGlvbnMuaWdub3JlVW5pcXVlS2V5ICYmXG4gICAgb3B0aW9ucy5pZCAmJlxuICAgIHR5cGVvZiBmcmFnbWVudC5pZCAhPT0gJ3VuZGVmaW5lZCdcbiAgKSB7XG4gICAgcmV0dXJuIFdpdGguZXhhY3RJZChmcmFnbWVudC5pZCk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGJ1aWxkQ2xhc3NOYW1lQ29uZGl0aW9uID0gKFxuICBmcmFnbWVudDogRWxlbWVudEZyYWdtZW50LFxuICBvcHRpb25zOiBYUGF0aElubmVyT3B0aW9uc1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuKTogYW55ID0+IHtcbiAgaWYgKFxuICAgICghb3B0aW9ucy5pZ25vcmVVbmlxdWVLZXkgJiZcbiAgICAgIGZyYWdtZW50LnVuaXF1ZUtleSA9PT0gVW5pcXVlS2V5LkNsYXNzTmFtZSAmJlxuICAgICAgZnJhZ21lbnQuY2xhc3NOYW1lcy5sZW5ndGggPiAwKSB8fFxuICAgIChvcHRpb25zLmNsYXNzTmFtZSAmJiBmcmFnbWVudC5jbGFzc05hbWVzLmxlbmd0aCA+IDApXG4gICkge1xuICAgIGNvbnN0IGFyciA9IGZyYWdtZW50LmNsYXNzTmFtZXMubWFwKChjbikgPT4gV2l0aC5hdHRyaWJ1dGUoJ2NsYXNzJywgY24pKTtcbiAgICByZXR1cm4gb3B0aW9ucy5zdHJpY3QgPyBqb2luQ29uZGl0aW9uc0J5QW5kKGFycikgOiBqb2luQ29uZGl0aW9uc0J5T3IoYXJyKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgYnVpbGRSb2xlQ29uZGl0aW9uID0gKFxuICBmcmFnbWVudDogRWxlbWVudEZyYWdtZW50LFxuICBvcHRpb25zOiBYUGF0aElubmVyT3B0aW9uc1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuKTogYW55ID0+IHtcbiAgaWYgKFxuICAgICghb3B0aW9ucy5pZ25vcmVVbmlxdWVLZXkgJiZcbiAgICAgIGZyYWdtZW50LnVuaXF1ZUtleSA9PT0gVW5pcXVlS2V5LlJvbGUgJiZcbiAgICAgIGZyYWdtZW50LnJvbGVzLmxlbmd0aCA+IDApIHx8XG4gICAgKG9wdGlvbnMucm9sZSAmJiBmcmFnbWVudC5yb2xlcy5sZW5ndGggPiAwKVxuICApIHtcbiAgICBjb25zdCBhcnIgPSBmcmFnbWVudC5yb2xlcy5tYXAoKHIpID0+IFdpdGguYXR0cmlidXRlKCdyb2xlJywgcikpO1xuICAgIHJldHVybiBvcHRpb25zLnN0cmljdCA/IGpvaW5Db25kaXRpb25zQnlBbmQoYXJyKSA6IGpvaW5Db25kaXRpb25zQnlPcihhcnIpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBidWlsZFBvc2l0aW9uQ29uZGl0aW9uID0gKFxuICBmcmFnbWVudDogRWxlbWVudEZyYWdtZW50LFxuICBvcHRpb25zOiBYUGF0aElubmVyT3B0aW9uc1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuKTogYW55ID0+IHtcbiAgaWYgKCFvcHRpb25zLmlnbm9yZVVuaXF1ZUtleSkge1xuICAgIGlmIChcbiAgICAgIGZyYWdtZW50LnVuaXF1ZUtleSA9PT0gVW5pcXVlS2V5LkluZGV4ICYmXG4gICAgICBmcmFnbWVudC5oYXNTaWJsaW5ncyAmJlxuICAgICAgZnJhZ21lbnQuaW5kZXggKyAxXG4gICAgKSB7XG4gICAgICByZXR1cm4gV2l0aC5wb3NpdGlvbihmcmFnbWVudC5pbmRleCArIDEpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZiAoIWZyYWdtZW50Lmhhc1NpYmxpbmdzIHx8IGZyYWdtZW50LmluZGV4ID09PSAtMSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucy5pZCAmJiB0eXBlb2YgZnJhZ21lbnQuaWQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgIChvcHRpb25zLmNsYXNzTmFtZSAmJiBmcmFnbWVudC5jbGFzc05hbWVzLmxlbmd0aCA+IDApIHx8XG4gICAgICAob3B0aW9ucy5yb2xlICYmIGZyYWdtZW50LnJvbGVzLmxlbmd0aCA+IDApXG4gICAgKSB7XG4gICAgICByZXR1cm4gbmV3IENvbmRpdGlvbihgcG9zaXRpb24oKSA9ICR7ZnJhZ21lbnQuaW5kZXggKyAxfWApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gV2l0aC5wb3NpdGlvbihmcmFnbWVudC5pbmRleCArIDEpO1xuICAgIH1cbiAgfVxufTtcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbmV4cG9ydCBjb25zdCBqb2luQ29uZGl0aW9uc0J5QW5kID0gKGNvbmRpdGlvbnM6IGFueVtdKTogYW55ID0+IHtcbiAgcmV0dXJuIGNvbmRpdGlvbnMucmVkdWNlKChhY2MsIGN1cnJlbnQpID0+IHtcbiAgICByZXR1cm4gYWNjLmFuZChjdXJyZW50KTtcbiAgfSk7XG59O1xuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuZXhwb3J0IGNvbnN0IGpvaW5Db25kaXRpb25zQnlPciA9IChjb25kaXRpb25zOiBhbnlbXSk6IGFueSA9PiB7XG4gIHJldHVybiBjb25kaXRpb25zLnJlZHVjZSgoYWNjLCBjdXJyZW50KSA9PiB7XG4gICAgcmV0dXJuIGFjYy5vcihjdXJyZW50KTtcbiAgfSk7XG59O1xuIl19