"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.evaluateXPath = exports.getMultipleSiblingsElements = exports.getSiblingsElements = exports.findElementsWithPredicate = exports.findElements = exports.getElement = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _xpath = require("../xpath");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _unsupportedIterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _iterableToArray(iter) { if (typeof Symbol !== "undefined" && Symbol.iterator in Object(iter)) return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) return _arrayLikeToArray(arr); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

var getElement = function getElement(identifier) {
  var ignoreClassNames = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;

  var last = _lodash.default.last(identifier.absolute);

  if (!last) {
    return undefined;
  }

  var xpath = (0, _xpath.toAbsoluteXPath)(identifier);
  var result = evaluateXPath(xpath, document, document);

  if (result.length === 1 && isMatchedAttributes(result[0], last, ignoreClassNames)) {
    return result[0];
  } else {
    return undefined;
  }
};

exports.getElement = getElement;

var findElements = function findElements(identifier) {
  var ignoreClassNames = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;

  var last = _lodash.default.last(identifier.absolute);

  if (!last) {
    return [];
  }

  var strictElement = getElement(identifier, ignoreClassNames, document);

  if (strictElement) {
    return [strictElement];
  }

  var uniqueXPath = (0, _xpath.toUniqueXPath)(identifier);
  var uniqueResult = evaluateXPath(uniqueXPath, document, document);
  var uniqueMatched = uniqueResult.filter(function (e) {
    return isMatchedAttributes(e, last, ignoreClassNames);
  });

  if (uniqueMatched.length === 1) {
    return uniqueMatched;
  }

  var elements = [];
  var fragments = [];

  for (var i = 0; i < identifier.absolute.length; i++) {
    var fragment = identifier.absolute[identifier.absolute.length - 1 - i];
    fragments = [fragment].concat(_toConsumableArray(fragments));
    var xpath = (0, _xpath.greedyXPathFromFragments)(fragments);
    var elems = evaluateXPath(xpath, document, document);
    var matched = elems.filter(function (e) {
      return isMatchedAttributes(e, last, ignoreClassNames);
    });

    if (matched.length === 1) {
      elements = matched;
      break;
    } else if (matched.length > 1) {
      elements = matched;
    }
  }

  return elements;
};

exports.findElements = findElements;

var findElementsWithPredicate = function findElementsWithPredicate(identifier, predicate) {
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;

  var last = _lodash.default.last(identifier.absolute);

  if (!last) {
    return [];
  }

  var uniqueXPath = (0, _xpath.toUniqueXPath)(identifier);
  var uniqueResult = evaluateXPath(uniqueXPath, document, document);
  var uniqueMatched = uniqueResult.filter(predicate);

  if (uniqueMatched.length === 1) {
    return uniqueMatched;
  }

  var elements = [];
  var fragments = [];

  for (var i = 0; i < identifier.absolute.length; i++) {
    var fragment = identifier.absolute[identifier.absolute.length - 1 - i];
    fragments = [fragment].concat(_toConsumableArray(fragments));
    var xpath = (0, _xpath.greedyXPathFromFragments)(fragments);
    var elems = evaluateXPath(xpath, document, document);
    var matched = elems.filter(predicate);

    if (matched.length === 1) {
      elements = matched;
      break;
    } else if (matched.length > 1) {
      elements = matched;
    }
  }

  return elements;
};

exports.findElementsWithPredicate = findElementsWithPredicate;

var getSiblingsElements = function getSiblingsElements(identifier) {
  var ignoreClassNames = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;
  var identifiers = !Array.isArray(identifier) ? [identifier] : identifier;
  var lasts = identifiers.map(function (i) {
    return _lodash.default.last(i.absolute);
  }).filter(function (f) {
    return typeof f !== 'undefined';
  });

  if (lasts.length === 0) {
    return [];
  }

  var xpath = (0, _xpath.toSiblingsXPath)(identifier);
  var elements = evaluateXPath(xpath, document, document);
  return elements.filter(function (e) {
    return lasts.some(function (f) {
      return isMatchedAttributes(e, f, ignoreClassNames);
    });
  });
};

exports.getSiblingsElements = getSiblingsElements;

var getMultipleSiblingsElements = function getMultipleSiblingsElements(identifiers) {
  var ignoreClassNames = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;

  if (identifiers.length === 0) {
    return [];
  }

  if (identifiers.length === 1) {
    var result = getSiblingsElements(identifiers[0], ignoreClassNames, document);
    return [result];
  }

  var ancestorXPath = (0, _xpath.toAncestorXPath)(identifiers);
  var ancestorElements = evaluateXPath(ancestorXPath, document, document);
  var elementsArray = identifiers.map(function (identifier) {
    return getSiblingsElements(identifier, ignoreClassNames, document);
  });
  var maxLength = elementsArray.reduce(function (acc, current) {
    return current.length > acc ? current.length : acc;
  }, 0);

  if (ancestorElements.length === maxLength) {
    var grouped = ancestorElements.map(function (ancestor) {
      return elementsArray.map(function (elements) {
        return elements.find(function (e) {
          return (// tslint:disable-next-line
            ancestor.compareDocumentPosition(e) & 16
          );
        } //Node.DOCUMENT_POSITION_CONTAINED_BY
        );
      });
    });
    return _lodash.default.zip.apply(_lodash.default, _toConsumableArray(grouped));
  } else {
    return elementsArray;
  }
};

exports.getMultipleSiblingsElements = getMultipleSiblingsElements;

var isMatchedAttributes = function isMatchedAttributes(element, fragment, ignoreClassNames) {
  return isMatchedId(element, fragment) && isMatchedClassNames(element, fragment, ignoreClassNames) && isMatchedRoles(element, fragment);
};

var isMatchedId = function isMatchedId(element, fragment) {
  var id = element.id.length > 0 ? element.id : undefined;
  return fragment.id === id;
};

var isMatchedClassNames = function isMatchedClassNames(element, fragment, ignoreClassNames) {
  var classNames = Array.from(element.classList).filter(function (cn) {
    return !ignoreClassNames.includes(cn);
  });

  if (fragment.classNames.length === 0 && classNames.length === 0) {
    return true;
  }

  var intersected = _lodash.default.intersection(fragment.classNames, classNames);

  return intersected.length > 0;
};

var isMatchedRoles = function isMatchedRoles(element, fragment) {
  var roleString = element.getAttribute('role');
  var roles = roleString ? roleString.split(' ') : [];

  if (fragment.roles.length === 0 && roles.length === 0) {
    return true;
  }

  var intersected = _lodash.default.intersection(fragment.roles, roles);

  return intersected.length > 0;
};

var evaluateXPath = function evaluateXPath(xpath) {
  var root = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : window.document;
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;
  var result = document.evaluate(root === document && !/^\./.test(xpath) ? xpath : ".".concat(xpath), root, null, 7, // XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,
  null);
  var elements = [];

  for (var i = 0; i < result.snapshotLength; i++) {
    var node = result.snapshotItem(i);

    if (node && node.nodeType === 1) {
      // Node.ELEMENT_NODE
      elements.push(node);
    }
  }

  return elements;
};

exports.evaluateXPath = evaluateXPath;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9maW5kZXIvaW5kZXgudHMiXSwibmFtZXMiOlsiZ2V0RWxlbWVudCIsImlkZW50aWZpZXIiLCJpZ25vcmVDbGFzc05hbWVzIiwiZG9jdW1lbnQiLCJ3aW5kb3ciLCJsYXN0IiwiXyIsImFic29sdXRlIiwidW5kZWZpbmVkIiwieHBhdGgiLCJyZXN1bHQiLCJldmFsdWF0ZVhQYXRoIiwibGVuZ3RoIiwiaXNNYXRjaGVkQXR0cmlidXRlcyIsImZpbmRFbGVtZW50cyIsInN0cmljdEVsZW1lbnQiLCJ1bmlxdWVYUGF0aCIsInVuaXF1ZVJlc3VsdCIsInVuaXF1ZU1hdGNoZWQiLCJmaWx0ZXIiLCJlIiwiZWxlbWVudHMiLCJmcmFnbWVudHMiLCJpIiwiZnJhZ21lbnQiLCJlbGVtcyIsIm1hdGNoZWQiLCJmaW5kRWxlbWVudHNXaXRoUHJlZGljYXRlIiwicHJlZGljYXRlIiwiZ2V0U2libGluZ3NFbGVtZW50cyIsImlkZW50aWZpZXJzIiwiQXJyYXkiLCJpc0FycmF5IiwibGFzdHMiLCJtYXAiLCJmIiwic29tZSIsImdldE11bHRpcGxlU2libGluZ3NFbGVtZW50cyIsImFuY2VzdG9yWFBhdGgiLCJhbmNlc3RvckVsZW1lbnRzIiwiZWxlbWVudHNBcnJheSIsIm1heExlbmd0aCIsInJlZHVjZSIsImFjYyIsImN1cnJlbnQiLCJncm91cGVkIiwiYW5jZXN0b3IiLCJmaW5kIiwiY29tcGFyZURvY3VtZW50UG9zaXRpb24iLCJ6aXAiLCJlbGVtZW50IiwiaXNNYXRjaGVkSWQiLCJpc01hdGNoZWRDbGFzc05hbWVzIiwiaXNNYXRjaGVkUm9sZXMiLCJpZCIsImNsYXNzTmFtZXMiLCJmcm9tIiwiY2xhc3NMaXN0IiwiY24iLCJpbmNsdWRlcyIsImludGVyc2VjdGVkIiwiaW50ZXJzZWN0aW9uIiwicm9sZVN0cmluZyIsImdldEF0dHJpYnV0ZSIsInJvbGVzIiwic3BsaXQiLCJyb290IiwiZXZhbHVhdGUiLCJ0ZXN0Iiwic25hcHNob3RMZW5ndGgiLCJu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QjtBQUNBbkQsTUFBQUEsUUFBUSxDQUFDb0QsSUFBVCxDQUFjSCxJQUFkO0FBQ0Q7QUFDRjs7QUFFRCxTQUFPakQsUUFBUDtBQUNELENBdkJNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuaW1wb3J0IHsgRWxlbWVudElkZW50aWZpZXIsIEVsZW1lbnRGcmFnbWVudCB9IGZyb20gJy4uL2lkZW50aWZpZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQge1xuICB0b0Fic29sdXRlWFBhdGgsXG4gIHRvVW5pcXVlWFBhdGgsXG4gIHRvU2libGluZ3NYUGF0aCxcbiAgdG9BbmNlc3RvclhQYXRoLFxuICBncmVlZHlYUGF0aEZyb21GcmFnbWVudHMsXG59IGZyb20gJy4uL3hwYXRoJztcblxuZXhwb3J0IGNvbnN0IGdldEVsZW1lbnQgPSAoXG4gIGlkZW50aWZpZXI6IEVsZW1lbnRJZGVudGlmaWVyLFxuICBpZ25vcmVDbGFzc05hbWVzOiBzdHJpbmdbXSA9IFtdLFxuICBkb2N1bWVudDogRG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnRcbik6IEVsZW1lbnQgfCB1bmRlZmluZWQgPT4ge1xuICBjb25zdCBsYXN0ID0gXy5sYXN0KGlkZW50aWZpZXIuYWJzb2x1dGUpO1xuICBpZiAoIWxhc3QpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3QgeHBhdGggPSB0b0Fic29sdXRlWFBhdGgoaWRlbnRpZmllcik7XG4gIGNvbnN0IHJlc3VsdCA9IGV2YWx1YXRlWFBhdGgoeHBhdGgsIGRvY3VtZW50LCBkb2N1bWVudCk7XG5cbiAgaWYgKFxuICAgIHJlc3VsdC5sZW5ndGggPT09IDEgJiZcbiAgICBpc01hdGNoZWRBdHRyaWJ1dGVzKHJlc3VsdFswXSwgbGFzdCwgaWdub3JlQ2xhc3NOYW1lcylcbiAgKSB7XG4gICAgcmV0dXJuIHJlc3VsdFswXTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgZmluZEVsZW1lbnRzID0gKFxuICBpZGVudGlmaWVyOiBFbGVtZW50SWRlbnRpZmllcixcbiAgaWdub3JlQ2xhc3NOYW1lczogc3RyaW5nW10gPSBbXSxcbiAgZG9jdW1lbnQ6IERvY3VtZW50ID0gd2luZG93LmRvY3VtZW50XG4pOiBFbGVtZW50W10gPT4ge1xuICBjb25zdCBsYXN0ID0gXy5sYXN0KGlkZW50aWZpZXIuYWJzb2x1dGUpO1xuICBpZiAoIWxhc3QpIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBjb25zdCBzdHJpY3RFbGVtZW50ID0gZ2V0RWxlbWVudChpZGVudGlmaWVyLCBpZ25vcmVDbGFzc05hbWVzLCBkb2N1bWVudCk7XG4gIGlmIChzdHJpY3RFbGVtZW50KSB7XG4gICAgcmV0dXJuIFtzdHJpY3RFbGVtZW50XTtcbiAgfVxuXG4gIGNvbnN0IHVuaXF1ZVhQYXRoID0gdG9VbmlxdWVYUGF0aChpZGVudGlmaWVyKTtcbiAgY29uc3QgdW5pcXVlUmVzdWx0ID0gZXZhbHVhdGVYUGF0aCh1bmlxdWVYUGF0aCwgZG9jdW1lbnQsIGRvY3VtZW50KTtcbiAgY29uc3QgdW5pcXVlTWF0Y2hlZCA9IHVuaXF1ZVJlc3VsdC5maWx0ZXIoZSA9PlxuICAgIGlzTWF0Y2hlZEF0dHJpYnV0ZXMoZSwgbGFzdCwgaWdub3JlQ2xhc3NOYW1lcylcbiAgKTtcbiAgaWYgKHVuaXF1ZU1hdGNoZWQubGVuZ3RoID09PSAxKSB7XG4gICAgcmV0dXJuIHVuaXF1ZU1hdGNoZWQ7XG4gIH1cblxuICBsZXQgZWxlbWVudHM6IEVsZW1lbnRbXSA9IFtdO1xuICBsZXQgZnJhZ21lbnRzOiBFbGVtZW50RnJhZ21lbnRbXSA9IFtdO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGlkZW50aWZpZXIuYWJzb2x1dGUubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCBmcmFnbWVudCA9IGlkZW50aWZpZXIuYWJzb2x1dGVbaWRlbnRpZmllci5hYnNvbHV0ZS5sZW5ndGggLSAxIC0gaV07XG4gICAgZnJhZ21lbnRzID0gW2ZyYWdtZW50LCAuLi5mcmFnbWVudHNdO1xuICAgIGNvbnN0IHhwYXRoID0gZ3JlZWR5WFBhdGhGcm9tRnJhZ21lbnRzKGZyYWdtZW50cyk7XG4gICAgY29uc3QgZWxlbXMgPSBldmFsdWF0ZVhQYXRoKHhwYXRoLCBkb2N1bWVudCwgZG9jdW1lbnQpO1xuICAgIGNvbnN0IG1hdGNoZWQgPSBlbGVtcy5maWx0ZXIoZSA9PlxuICAgICAgaXNNYXRjaGVkQXR0cmlidXRlcyhlLCBsYXN0LCBpZ25vcmVDbGFzc05hbWVzKVxuICAgICk7XG4gICAgaWYgKG1hdGNoZWQubGVuZ3RoID09PSAxKSB7XG4gICAgICBlbGVtZW50cyA9IG1hdGNoZWQ7XG4gICAgICBicmVhaztcbiAgICB9IGVsc2UgaWYgKG1hdGNoZWQubGVuZ3RoID4gMSkge1xuICAgICAgZWxlbWVudHMgPSBtYXRjaGVkO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBlbGVtZW50cztcbn07XG5cbmV4cG9ydCBjb25zdCBmaW5kRWxlbWVudHNXaXRoUHJlZGljYXRlID0gKFxuICBpZGVudGlmaWVyOiBFbGVtZW50SWRlbnRpZmllcixcbiAgcHJlZGljYXRlOiAoZWxlbWVudDogRWxlbWVudCkgPT4gYm9vbGVhbixcbiAgZG9jdW1lbnQ6IERvY3VtZW50ID0gd2luZG93LmRvY3VtZW50XG4pOiBFbGVtZW50W10gPT4ge1xuICBjb25zdCBsYXN0ID0gXy5sYXN0KGlkZW50aWZpZXIuYWJzb2x1dGUpO1xuICBpZiAoIWxhc3QpIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBjb25zdCB1bmlxdWVYUGF0aCA9IHRvVW5pcXVlWFBhdGgoaWRlbnRpZmllcik7XG4gIGNvbnN0IHVuaXF1ZVJlc3VsdCA9IGV2YWx1YXRlWFBhdGgodW5pcXVlWFBhdGgsIGRvY3VtZW50LCBkb2N1bWVudCk7XG4gIGNvbnN0IHVuaXF1ZU1hdGNoZWQgPSB1bmlxdWVSZXN1bHQuZmlsdGVyKHByZWRpY2F0ZSk7XG4gIGlmICh1bmlxdWVNYXRjaGVkLmxlbmd0aCA9PT0gMSkge1xuICAgIHJldHVybiB1bmlxdWVNYXRjaGVkO1xuICB9XG5cbiAgbGV0IGVsZW1lbnRzOiBFbGVtZW50W10gPSBbXTtcbiAgbGV0IGZyYWdtZW50czogRWxlbWVudEZyYWdtZW50W10gPSBbXTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBpZGVudGlmaWVyLmFic29sdXRlLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgZnJhZ21lbnQgPSBpZGVudGlmaWVyLmFic29sdXRlW2lkZW50aWZpZXIuYWJzb2x1dGUubGVuZ3RoIC0gMSAtIGldO1xuICAgIGZyYWdtZW50cyA9IFtmcmFnbWVudCwgLi4uZnJhZ21lbnRzXTtcbiAgICBjb25zdCB4cGF0aCA9IGdyZWVkeVhQYXRoRnJvbUZyYWdtZW50cyhmcmFnbWVudHMpO1xuICAgIGNvbnN0IGVsZW1zID0gZXZhbHVhdGVYUGF0aCh4cGF0aCwgZG9jdW1lbnQsIGRvY3VtZW50KTtcbiAgICBjb25zdCBtYXRjaGVkID0gZWxlbXMuZmlsdGVyKHByZWRpY2F0ZSk7XG4gICAgaWYgKG1hdGNoZWQubGVuZ3RoID09PSAxKSB7XG4gICAgICBlbGVtZW50cyA9IG1hdGNoZWQ7XG4gICAgICBicmVhaztcbiAgICB9IGVsc2UgaWYgKG1hdGNoZWQubGVuZ3RoID4gMSkge1xuICAgICAgZWxlbWVudHMgPSBtYXRjaGVkO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBlbGVtZW50cztcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRTaWJsaW5nc0VsZW1lbnRzID0gKFxuICBpZGVudGlmaWVyOiBFbGVtZW50SWRlbnRpZmllciB8IEVsZW1lbnRJZGVudGlmaWVyW10sXG4gIGlnbm9yZUNsYXNzTmFtZXM6IHN0cmluZ1tdID0gW10sXG4gIGRvY3VtZW50OiBEb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudFxuKTogRWxlbWVudFtdID0+IHtcbiAgY29uc3QgaWRlbnRpZmllcnMgPSAhQXJyYXkuaXNBcnJheShpZGVudGlmaWVyKSA/IFtpZGVudGlmaWVyXSA6IGlkZW50aWZpZXI7XG4gIGNvbnN0IGxhc3RzID0gaWRlbnRpZmllcnNcbiAgICAubWFwKGkgPT4gXy5sYXN0KGkuYWJzb2x1dGUpKVxuICAgIC5maWx0ZXIoZiA9PiB0eXBlb2YgZiAhPT0gJ3VuZGVmaW5lZCcpIGFzIEVsZW1lbnRGcmFnbWVudFtdO1xuXG4gIGlmIChsYXN0cy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBjb25zdCB4cGF0aCA9IHRvU2libGluZ3NYUGF0aChpZGVudGlmaWVyKTtcbiAgY29uc3QgZWxlbWVudHMgPSBldmFsdWF0ZVhQYXRoKHhwYXRoLCBkb2N1bWVudCwgZG9jdW1lbnQpO1xuXG4gIHJldHVybiBlbGVtZW50cy5maWx0ZXIoZSA9PiB7XG4gICAgcmV0dXJuIGxhc3RzLnNvbWUoZiA9PiBpc01hdGNoZWRBdHRyaWJ1dGVzKGUsIGYsIGlnbm9yZUNsYXNzTmFtZXMpKTtcbiAgfSk7XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0TXVsdGlwbGVTaWJsaW5nc0VsZW1lbnRzID0gKFxuICBpZGVudGlmaWVyczogRWxlbWVudElkZW50aWZpZXJbXVtdLFxuICBpZ25vcmVDbGFzc05hbWVzOiBzdHJpbmdbXSA9IFtdLFxuICBkb2N1bWVudDogRG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnRcbik6IChFbGVtZW50IHwgdW5kZWZpbmVkKVtdW10gPT4ge1xuICBpZiAoaWRlbnRpZmllcnMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgaWYgKGlkZW50aWZpZXJzLmxlbmd0aCA9PT0gMSkge1xuICAgIGNvbnN0IHJlc3VsdCA9IGdldFNpYmxpbmdzRWxlbWVudHMoXG4gICAgICBpZGVudGlmaWVyc1swXSxcbiAgICAgIGlnbm9yZUNsYXNzTmFtZXMsXG4gICAgICBkb2N1bWVudFxuICAgICk7XG4gICAgcmV0dXJuIFtyZXN1bHRdO1xuICB9XG5cbiAgY29uc3QgYW5jZXN0b3JYUGF0aCA9IHRvQW5jZXN0b3JYUGF0aChpZGVudGlmaWVycyk7XG4gIGNvbnN0IGFuY2VzdG9yRWxlbWVudHMgPSBldmFsdWF0ZVhQYXRoKGFuY2VzdG9yWFBhdGgsIGRvY3VtZW50LCBkb2N1bWVudCk7XG5cbiAgY29uc3QgZWxlbWVudHNBcnJheSA9IGlkZW50aWZpZXJzLm1hcChpZGVudGlmaWVyID0+IHtcbiAgICByZXR1cm4gZ2V0U2libGluZ3NFbGVtZW50cyhpZGVudGlmaWVyLCBpZ25vcmVDbGFzc05hbWVzLCBkb2N1bWVudCk7XG4gIH0pO1xuXG4gIGNvbnN0IG1heExlbmd0aCA9IGVsZW1lbnRzQXJyYXkucmVkdWNlKChhY2MsIGN1cnJlbnQpID0+IHtcbiAgICByZXR1cm4gY3VycmVudC5sZW5ndGggPiBhY2MgPyBjdXJyZW50Lmxlbmd0aCA6IGFjYztcbiAgfSwgMCk7XG5cbiAgaWYgKGFuY2VzdG9yRWxlbWVudHMubGVuZ3RoID09PSBtYXhMZW5ndGgpIHtcbiAgICBjb25zdCBncm91cGVkID0gYW5jZXN0b3JFbGVtZW50cy5tYXAoYW5jZXN0b3IgPT4ge1xuICAgICAgcmV0dXJuIGVsZW1lbnRzQXJyYXkubWFwKGVsZW1lbnRzID0+IHtcbiAgICAgICAgcmV0dXJuIGVsZW1lbnRzLmZpbmQoXG4gICAgICAgICAgZSA9PlxuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lXG4gICAgICAgICAgICBhbmNlc3Rvci5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihlKSAmIDE2IC8vTm9kZS5ET0NVTUVOVF9QT1NJVElPTl9DT05UQUlORURfQllcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiBfLnppcCguLi5ncm91cGVkKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gZWxlbWVudHNBcnJheTtcbiAgfVxufTtcblxuY29uc3QgaXNNYXRjaGVkQXR0cmlidXRlcyA9IChcbiAgZWxlbWVudDogRWxlbWVudCxcbiAgZnJhZ21lbnQ6IEVsZW1lbnRGcmFnbWVudCxcbiAgaWdub3JlQ2xhc3NOYW1lczogc3RyaW5nW11cbik6IGJvb2xlYW4gPT4ge1xuICByZXR1cm4gKFxuICAgIGlzTWF0Y2hlZElkKGVsZW1lbnQsIGZyYWdtZW50KSAmJlxuICAgIGlzTWF0Y2hlZENsYXNzTmFtZXMoZWxlbWVudCwgZnJhZ21lbnQsIGlnbm9yZUNsYXNzTmFtZXMpICYmXG4gICAgaXNNYXRjaGVkUm9sZXMoZWxlbWVudCwgZnJhZ21lbnQpXG4gICk7XG59O1xuXG5jb25zdCBpc01hdGNoZWRJZCA9IChlbGVtZW50OiBFbGVtZW50LCBmcmFnbWVudDogRWxlbWVudEZyYWdtZW50KTogYm9vbGVhbiA9PiB7XG4gIGNvbnN0IGlkID0gZWxlbWVudC5pZC5sZW5ndGggPiAwID8gZWxlbWVudC5pZCA6IHVuZGVmaW5lZDtcbiAgcmV0dXJuIGZyYWdtZW50LmlkID09PSBpZDtcbn07XG5cbmNvbnN0IGlzTWF0Y2hlZENsYXNzTmFtZXMgPSAoXG4gIGVsZW1lbnQ6IEVsZW1lbnQsXG4gIGZyYWdtZW50OiBFbGVtZW50RnJhZ21lbnQsXG4gIGlnbm9yZUNsYXNzTmFtZXM6IHN0cmluZ1tdXG4pOiBib29sZWFuID0+IHtcbiAgY29uc3QgY2xhc3NOYW1lcyA9IEFycmF5LmZyb20oZWxlbWVudC5jbGFzc0xpc3QpLmZpbHRlcihcbiAgICBjbiA9PiAhaWdub3JlQ2xhc3NOYW1lcy5pbmNsdWRlcyhjbilcbiAgKTtcblxuICBpZiAoZnJhZ21lbnQuY2xhc3NOYW1lcy5sZW5ndGggPT09IDAgJiYgY2xhc3NOYW1lcy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGNvbnN0IGludGVyc2VjdGVkID0gXy5pbnRlcnNlY3Rpb24oZnJhZ21lbnQuY2xhc3NOYW1lcywgY2xhc3NOYW1lcyk7XG4gIHJldHVybiBpbnRlcnNlY3RlZC5sZW5ndGggPiAwO1xufTtcblxuY29uc3QgaXNNYXRjaGVkUm9sZXMgPSAoXG4gIGVsZW1lbnQ6IEVsZW1lbnQsXG4gIGZyYWdtZW50OiBFbGVtZW50RnJhZ21lbnRcbik6IGJvb2xlYW4gPT4ge1xuICBjb25zdCByb2xlU3RyaW5nID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3JvbGUnKTtcbiAgY29uc3Qgcm9sZXMgPSByb2xlU3RyaW5nID8gcm9sZVN0cmluZy5zcGxpdCgnICcpIDogW107XG4gIGlmIChmcmFnbWVudC5yb2xlcy5sZW5ndGggPT09IDAgJiYgcm9sZXMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBjb25zdCBpbnRlcnNlY3RlZCA9IF8uaW50ZXJzZWN0aW9uKGZyYWdtZW50LnJvbGVzLCByb2xlcyk7XG4gIHJldHVybiBpbnRlcnNlY3RlZC5sZW5ndGggPiAwO1xufTtcblxuZXhwb3J0IGNvbnN0IGV2YWx1YXRlWFBhdGggPSAoXG4gIHhwYXRoOiBzdHJpbmcsXG4gIHJvb3Q6IE5vZGUgPSB3aW5kb3cuZG9jdW1lbnQsXG4gIGRvY3VtZW50OiBEb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudFxuKTogRWxlbWVudFtdID0+IHtcbiAgY29uc3QgcmVzdWx0ID0gZG9jdW1lbnQuZXZhbHVhdGUoXG4gICAgcm9vdCA9PT0gZG9jdW1lbnQgJiYgIS9eXFwuLy50ZXN0KHhwYXRoKSA/IHhwYXRoIDogYC4ke3hwYXRofWAsXG4gICAgcm9vdCxcbiAgICBudWxsLFxuICAgIDcsIC8vIFhQYXRoUmVzdWx0Lk9SREVSRURfTk9ERV9TTkFQU0hPVF9UWVBFLFxuICAgIG51bGxcbiAgKTtcblxuICBjb25zdCBlbGVtZW50czogRWxlbWVudFtdID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgcmVzdWx0LnNuYXBzaG90TGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCBub2RlID0gcmVzdWx0LnNuYXBzaG90SXRlbShpKTtcbiAgICBpZiAobm9kZSAmJiBub2RlLm5vZGVUeXBlID09PSAxKSB7XG4gICAgICAvLyBOb2RlLkVMRU1FTlRfTk9ERVxuICAgICAgZWxlbWVudHMucHVzaChub2RlIGFzIEVsZW1lbnQpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBlbGVtZW50cztcbn07XG4iXX0=