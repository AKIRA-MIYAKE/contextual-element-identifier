"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getSiblingsElements = exports.getMultipleSiblingsElements = exports.getElement = exports.findElementsWithPredicate = exports.findElements = exports.evaluateXPath = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _xpath = require("../xpath");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _unsupportedIterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _iterableToArray(iter) { if (typeof Symbol !== "undefined" && iter[Symbol.iterator] != null || iter["@@iterator"] != null) return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) return _arrayLikeToArray(arr); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

var getElement = function getElement(identifier) {
  var ignoreClassNames = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;

  var last = _lodash.default.last(identifier.absolute);

  if (!last) {
    return undefined;
  }

  var xpath = (0, _xpath.toAbsoluteXPath)(identifier);
  var result = evaluateXPath(xpath, document, document);

  if (result.length === 1 && isMatchedAttributes(result[0], last, ignoreClassNames)) {
    return result[0];
  } else {
    return undefined;
  }
};

exports.getElement = getElement;

var findElements = function findElements(identifier) {
  var ignoreClassNames = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;

  var last = _lodash.default.last(identifier.absolute);

  if (!last) {
    return [];
  }

  var strictElement = getElement(identifier, ignoreClassNames, document);

  if (strictElement) {
    return [strictElement];
  }

  var uniqueXPath = (0, _xpath.toUniqueXPath)(identifier);
  var uniqueResult = evaluateXPath(uniqueXPath, document, document);
  var uniqueMatched = uniqueResult.filter(function (e) {
    return isMatchedAttributes(e, last, ignoreClassNames);
  });

  if (uniqueMatched.length === 1) {
    return uniqueMatched;
  }

  var elements = [];
  var fragments = [];

  for (var i = 0; i < identifier.absolute.length; i++) {
    var fragment = identifier.absolute[identifier.absolute.length - 1 - i];
    fragments = [fragment].concat(_toConsumableArray(fragments));
    var xpath = (0, _xpath.greedyXPathFromFragments)(fragments);
    var elems = evaluateXPath(xpath, document, document);
    var matched = elems.filter(function (e) {
      return isMatchedAttributes(e, last, ignoreClassNames);
    });

    if (matched.length === 1) {
      elements = matched;
      break;
    } else if (matched.length > 1) {
      elements = matched;
    }
  }

  return elements;
};

exports.findElements = findElements;

var findElementsWithPredicate = function findElementsWithPredicate(identifier, predicate) {
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;

  var last = _lodash.default.last(identifier.absolute);

  if (!last) {
    return [];
  }

  var uniqueXPath = (0, _xpath.toUniqueXPath)(identifier);
  var uniqueResult = evaluateXPath(uniqueXPath, document, document);
  var uniqueMatched = uniqueResult.filter(predicate);

  if (uniqueMatched.length === 1) {
    return uniqueMatched;
  }

  var elements = [];
  var fragments = [];

  for (var i = 0; i < identifier.absolute.length; i++) {
    var fragment = identifier.absolute[identifier.absolute.length - 1 - i];
    fragments = [fragment].concat(_toConsumableArray(fragments));
    var xpath = (0, _xpath.greedyXPathFromFragments)(fragments);
    var elems = evaluateXPath(xpath, document, document);
    var matched = elems.filter(predicate);

    if (matched.length === 1) {
      elements = matched;
      break;
    } else if (matched.length > 1) {
      elements = matched;
    }
  }

  return elements;
};

exports.findElementsWithPredicate = findElementsWithPredicate;

var getSiblingsElements = function getSiblingsElements(identifier) {
  var ignoreClassNames = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;
  var identifiers = !Array.isArray(identifier) ? [identifier] : identifier;
  var lasts = identifiers.map(function (i) {
    return _lodash.default.last(i.absolute);
  }).filter(function (f) {
    return typeof f !== 'undefined';
  });

  if (lasts.length === 0) {
    return [];
  }

  var xpath = (0, _xpath.toSiblingsXPath)(identifier);
  var elements = evaluateXPath(xpath, document, document);
  return elements.filter(function (e) {
    return lasts.some(function (f) {
      return isMatchedAttributes(e, f, ignoreClassNames);
    });
  });
};

exports.getSiblingsElements = getSiblingsElements;

var getMultipleSiblingsElements = function getMultipleSiblingsElements(identifiers) {
  var ignoreClassNames = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;

  if (identifiers.length === 0) {
    return [];
  }

  if (identifiers.length === 1) {
    var result = getSiblingsElements(identifiers[0], ignoreClassNames, document);
    return [result];
  }

  var ancestorXPath = (0, _xpath.toAncestorXPath)(identifiers);
  var ancestorElements = evaluateXPath(ancestorXPath, document, document);
  var elementsArray = identifiers.map(function (identifier) {
    return getSiblingsElements(identifier, ignoreClassNames, document);
  });
  var maxLength = elementsArray.reduce(function (acc, current) {
    return current.length > acc ? current.length : acc;
  }, 0);

  if (ancestorElements.length === maxLength) {
    var grouped = ancestorElements.map(function (ancestor) {
      return elementsArray.map(function (elements) {
        return elements.find(function (e) {
          return (// tslint:disable-next-line
            ancestor.compareDocumentPosition(e) & 16
          );
        } //Node.DOCUMENT_POSITION_CONTAINED_BY
        );
      });
    });
    return _lodash.default.zip.apply(_lodash.default, _toConsumableArray(grouped));
  } else {
    return elementsArray;
  }
};

exports.getMultipleSiblingsElements = getMultipleSiblingsElements;

var isMatchedAttributes = function isMatchedAttributes(element, fragment, ignoreClassNames) {
  return isMatchedId(element, fragment) && isMatchedClassNames(element, fragment, ignoreClassNames) && isMatchedRoles(element, fragment);
};

var isMatchedId = function isMatchedId(element, fragment) {
  var id = element.id.length > 0 ? element.id : undefined;
  return fragment.id === id;
};

var isMatchedClassNames = function isMatchedClassNames(element, fragment, ignoreClassNames) {
  var classNames = Array.from(element.classList).filter(function (cn) {
    return !ignoreClassNames.includes(cn);
  });

  if (fragment.classNames.length === 0 && classNames.length === 0) {
    return true;
  }

  var intersected = _lodash.default.intersection(fragment.classNames, classNames);

  return intersected.length > 0;
};

var isMatchedRoles = function isMatchedRoles(element, fragment) {
  var roleString = element.getAttribute('role');
  var roles = roleString ? roleString.split(' ') : [];

  if (fragment.roles.length === 0 && roles.length === 0) {
    return true;
  }

  var intersected = _lodash.default.intersection(fragment.roles, roles);

  return intersected.length > 0;
};

var evaluateXPath = function evaluateXPath(xpath) {
  var root = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : window.document;
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;
  var result = document.evaluate(root === document && !/^\./.test(xpath) ? xpath : ".".concat(xpath), root, null, 7, // XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,
  null);
  var elements = [];

  for (var i = 0; i < result.snapshotLength; i++) {
    var node = result.snapshotItem(i);

    if (node && node.nodeType === 1) {
      // Node.ELEMENT_NODE
      elements.push(node);
    }
  }

  return elements;
};

exports.evaluateXPath = evaluateXPath;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9maW5kZXIvaW5kZXgudHMiXSwibmFtZXMiOlsiZ2V0RWxlbWVudCIsImlkZW50aWZpZXIiLCJpZ25vcmVDbGFzc05hbWVzIiwiZG9jdW1lbnQiLCJ3aW5kb3ciLCJsYXN0IiwiXyIsImFic29sdXRlIiwidW5kZWZpbmVkIiwieHBhdGgiLCJyZXN1bHQiLCJldmFsdWF0ZVhQYXRoIiwibGVuZ3RoIiwiaXNNYXRjaGVkQXR0cmlidXRlcyIsImZpbmRFbGVtZW50cyIsInN0cmljdEVsZW1lbnQiLCJ1bmlxdWVYUGF0aCIsInVuaXF1ZVJlc3VsdCIsInVuaXF1ZU1hdGNoZWQiLCJmaWx0ZXIiLCJlIiwiZWxlbWVudHMiLCJmcmFnbWVudHMiLCJpIiwiZnJhZ21lbnQiLCJlbGVtcyIsIm1hdGNoZWQiLCJmaW5kRWxlbWVudHNXaXRoUHJlZGljYXRlIiwicHJlZGljYXRlIiwiZ2V0U2libGluZ3NFbGVtZW50cyIsImlkZW50aWZpZXJzIiwiQXJyYXkiLCJpc0FycmF5IiwibGFzdHMiLCJtYXAiLCJmIiwic29tZSIsImdldE11bHRpcGxlU2libGluZ3NFbGVtZW50cyIsImFuY2VzdG9yWFBhdGgiLCJhbmNlc3RvckVsZW1lbnRzIiwiZWxlbWVudHNBcnJheSIsIm1heExlbmd0aCIsInJlZHVjZSIsImFjYyIsImN1cnJlbnQiLCJncm91cGVkIiwiYW5jZXN0b3IiLCJmaW5kIiwiY29tcGFyZURvY3VtZW50UG9zaXRpb24iLCJ6aXAiLCJlbGVtZW50IiwiaXNNYXRjaGVkSWQiLCJpc01hdGNoZWRDbGFzc05hbWVzIiwiaXNNYXRjaGVkUm9sZXMiLCJpZCIsImNsYXNzTmFtZXMiLCJmcm9tIiwiY2xhc3NMaXN0IiwiY24iLCJpbmNsdWRlcyIsImludGVyc2VjdGVkIiwiaW50ZXJzZWN0aW9uIiwicm9sZVN0cmluZyIsImdldEF0dHJpYnV0ZSIsInJvbGVzIiwic3BsaXQiLCJyb290IiwiZXZhbHVhdGUiLCJ0ZXN0Iiwic25hcHNob3RMZW5ndGgiLCJu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Qy9CO0FBQ0FuRCxNQUFBQSxRQUFRLENBQUNvRCxJQUFULENBQWNILElBQWQ7QUFDRDtBQUNGOztBQUVELFNBQU9qRCxRQUFQO0FBQ0QsQ0F2Qk0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5pbXBvcnQgeyBFbGVtZW50SWRlbnRpZmllciwgRWxlbWVudEZyYWdtZW50IH0gZnJvbSAnLi4vaWRlbnRpZmllci9pbnRlcmZhY2VzJztcbmltcG9ydCB7XG4gIHRvQWJzb2x1dGVYUGF0aCxcbiAgdG9VbmlxdWVYUGF0aCxcbiAgdG9TaWJsaW5nc1hQYXRoLFxuICB0b0FuY2VzdG9yWFBhdGgsXG4gIGdyZWVkeVhQYXRoRnJvbUZyYWdtZW50cyxcbn0gZnJvbSAnLi4veHBhdGgnO1xuXG5leHBvcnQgY29uc3QgZ2V0RWxlbWVudCA9IChcbiAgaWRlbnRpZmllcjogRWxlbWVudElkZW50aWZpZXIsXG4gIGlnbm9yZUNsYXNzTmFtZXM6IHN0cmluZ1tdID0gW10sXG4gIGRvY3VtZW50OiBEb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudFxuKTogRWxlbWVudCB8IHVuZGVmaW5lZCA9PiB7XG4gIGNvbnN0IGxhc3QgPSBfLmxhc3QoaWRlbnRpZmllci5hYnNvbHV0ZSk7XG4gIGlmICghbGFzdCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCB4cGF0aCA9IHRvQWJzb2x1dGVYUGF0aChpZGVudGlmaWVyKTtcbiAgY29uc3QgcmVzdWx0ID0gZXZhbHVhdGVYUGF0aCh4cGF0aCwgZG9jdW1lbnQsIGRvY3VtZW50KTtcblxuICBpZiAoXG4gICAgcmVzdWx0Lmxlbmd0aCA9PT0gMSAmJlxuICAgIGlzTWF0Y2hlZEF0dHJpYnV0ZXMocmVzdWx0WzBdLCBsYXN0LCBpZ25vcmVDbGFzc05hbWVzKVxuICApIHtcbiAgICByZXR1cm4gcmVzdWx0WzBdO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBmaW5kRWxlbWVudHMgPSAoXG4gIGlkZW50aWZpZXI6IEVsZW1lbnRJZGVudGlmaWVyLFxuICBpZ25vcmVDbGFzc05hbWVzOiBzdHJpbmdbXSA9IFtdLFxuICBkb2N1bWVudDogRG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnRcbik6IEVsZW1lbnRbXSA9PiB7XG4gIGNvbnN0IGxhc3QgPSBfLmxhc3QoaWRlbnRpZmllci5hYnNvbHV0ZSk7XG4gIGlmICghbGFzdCkge1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIGNvbnN0IHN0cmljdEVsZW1lbnQgPSBnZXRFbGVtZW50KGlkZW50aWZpZXIsIGlnbm9yZUNsYXNzTmFtZXMsIGRvY3VtZW50KTtcbiAgaWYgKHN0cmljdEVsZW1lbnQpIHtcbiAgICByZXR1cm4gW3N0cmljdEVsZW1lbnRdO1xuICB9XG5cbiAgY29uc3QgdW5pcXVlWFBhdGggPSB0b1VuaXF1ZVhQYXRoKGlkZW50aWZpZXIpO1xuICBjb25zdCB1bmlxdWVSZXN1bHQgPSBldmFsdWF0ZVhQYXRoKHVuaXF1ZVhQYXRoLCBkb2N1bWVudCwgZG9jdW1lbnQpO1xuICBjb25zdCB1bmlxdWVNYXRjaGVkID0gdW5pcXVlUmVzdWx0LmZpbHRlcigoZSkgPT5cbiAgICBpc01hdGNoZWRBdHRyaWJ1dGVzKGUsIGxhc3QsIGlnbm9yZUNsYXNzTmFtZXMpXG4gICk7XG4gIGlmICh1bmlxdWVNYXRjaGVkLmxlbmd0aCA9PT0gMSkge1xuICAgIHJldHVybiB1bmlxdWVNYXRjaGVkO1xuICB9XG5cbiAgbGV0IGVsZW1lbnRzOiBFbGVtZW50W10gPSBbXTtcbiAgbGV0IGZyYWdtZW50czogRWxlbWVudEZyYWdtZW50W10gPSBbXTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBpZGVudGlmaWVyLmFic29sdXRlLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgZnJhZ21lbnQgPSBpZGVudGlmaWVyLmFic29sdXRlW2lkZW50aWZpZXIuYWJzb2x1dGUubGVuZ3RoIC0gMSAtIGldO1xuICAgIGZyYWdtZW50cyA9IFtmcmFnbWVudCwgLi4uZnJhZ21lbnRzXTtcbiAgICBjb25zdCB4cGF0aCA9IGdyZWVkeVhQYXRoRnJvbUZyYWdtZW50cyhmcmFnbWVudHMpO1xuICAgIGNvbnN0IGVsZW1zID0gZXZhbHVhdGVYUGF0aCh4cGF0aCwgZG9jdW1lbnQsIGRvY3VtZW50KTtcbiAgICBjb25zdCBtYXRjaGVkID0gZWxlbXMuZmlsdGVyKChlKSA9PlxuICAgICAgaXNNYXRjaGVkQXR0cmlidXRlcyhlLCBsYXN0LCBpZ25vcmVDbGFzc05hbWVzKVxuICAgICk7XG4gICAgaWYgKG1hdGNoZWQubGVuZ3RoID09PSAxKSB7XG4gICAgICBlbGVtZW50cyA9IG1hdGNoZWQ7XG4gICAgICBicmVhaztcbiAgICB9IGVsc2UgaWYgKG1hdGNoZWQubGVuZ3RoID4gMSkge1xuICAgICAgZWxlbWVudHMgPSBtYXRjaGVkO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBlbGVtZW50cztcbn07XG5cbmV4cG9ydCBjb25zdCBmaW5kRWxlbWVudHNXaXRoUHJlZGljYXRlID0gKFxuICBpZGVudGlmaWVyOiBFbGVtZW50SWRlbnRpZmllcixcbiAgcHJlZGljYXRlOiAoZWxlbWVudDogRWxlbWVudCkgPT4gYm9vbGVhbixcbiAgZG9jdW1lbnQ6IERvY3VtZW50ID0gd2luZG93LmRvY3VtZW50XG4pOiBFbGVtZW50W10gPT4ge1xuICBjb25zdCBsYXN0ID0gXy5sYXN0KGlkZW50aWZpZXIuYWJzb2x1dGUpO1xuICBpZiAoIWxhc3QpIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBjb25zdCB1bmlxdWVYUGF0aCA9IHRvVW5pcXVlWFBhdGgoaWRlbnRpZmllcik7XG4gIGNvbnN0IHVuaXF1ZVJlc3VsdCA9IGV2YWx1YXRlWFBhdGgodW5pcXVlWFBhdGgsIGRvY3VtZW50LCBkb2N1bWVudCk7XG4gIGNvbnN0IHVuaXF1ZU1hdGNoZWQgPSB1bmlxdWVSZXN1bHQuZmlsdGVyKHByZWRpY2F0ZSk7XG4gIGlmICh1bmlxdWVNYXRjaGVkLmxlbmd0aCA9PT0gMSkge1xuICAgIHJldHVybiB1bmlxdWVNYXRjaGVkO1xuICB9XG5cbiAgbGV0IGVsZW1lbnRzOiBFbGVtZW50W10gPSBbXTtcbiAgbGV0IGZyYWdtZW50czogRWxlbWVudEZyYWdtZW50W10gPSBbXTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBpZGVudGlmaWVyLmFic29sdXRlLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgZnJhZ21lbnQgPSBpZGVudGlmaWVyLmFic29sdXRlW2lkZW50aWZpZXIuYWJzb2x1dGUubGVuZ3RoIC0gMSAtIGldO1xuICAgIGZyYWdtZW50cyA9IFtmcmFnbWVudCwgLi4uZnJhZ21lbnRzXTtcbiAgICBjb25zdCB4cGF0aCA9IGdyZWVkeVhQYXRoRnJvbUZyYWdtZW50cyhmcmFnbWVudHMpO1xuICAgIGNvbnN0IGVsZW1zID0gZXZhbHVhdGVYUGF0aCh4cGF0aCwgZG9jdW1lbnQsIGRvY3VtZW50KTtcbiAgICBjb25zdCBtYXRjaGVkID0gZWxlbXMuZmlsdGVyKHByZWRpY2F0ZSk7XG4gICAgaWYgKG1hdGNoZWQubGVuZ3RoID09PSAxKSB7XG4gICAgICBlbGVtZW50cyA9IG1hdGNoZWQ7XG4gICAgICBicmVhaztcbiAgICB9IGVsc2UgaWYgKG1hdGNoZWQubGVuZ3RoID4gMSkge1xuICAgICAgZWxlbWVudHMgPSBtYXRjaGVkO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBlbGVtZW50cztcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRTaWJsaW5nc0VsZW1lbnRzID0gKFxuICBpZGVudGlmaWVyOiBFbGVtZW50SWRlbnRpZmllciB8IEVsZW1lbnRJZGVudGlmaWVyW10sXG4gIGlnbm9yZUNsYXNzTmFtZXM6IHN0cmluZ1tdID0gW10sXG4gIGRvY3VtZW50OiBEb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudFxuKTogRWxlbWVudFtdID0+IHtcbiAgY29uc3QgaWRlbnRpZmllcnMgPSAhQXJyYXkuaXNBcnJheShpZGVudGlmaWVyKSA/IFtpZGVudGlmaWVyXSA6IGlkZW50aWZpZXI7XG4gIGNvbnN0IGxhc3RzID0gaWRlbnRpZmllcnNcbiAgICAubWFwKChpKSA9PiBfLmxhc3QoaS5hYnNvbHV0ZSkpXG4gICAgLmZpbHRlcigoZikgPT4gdHlwZW9mIGYgIT09ICd1bmRlZmluZWQnKSBhcyBFbGVtZW50RnJhZ21lbnRbXTtcblxuICBpZiAobGFzdHMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgY29uc3QgeHBhdGggPSB0b1NpYmxpbmdzWFBhdGgoaWRlbnRpZmllcik7XG4gIGNvbnN0IGVsZW1lbnRzID0gZXZhbHVhdGVYUGF0aCh4cGF0aCwgZG9jdW1lbnQsIGRvY3VtZW50KTtcblxuICByZXR1cm4gZWxlbWVudHMuZmlsdGVyKChlKSA9PiB7XG4gICAgcmV0dXJuIGxhc3RzLnNvbWUoKGYpID0+IGlzTWF0Y2hlZEF0dHJpYnV0ZXMoZSwgZiwgaWdub3JlQ2xhc3NOYW1lcykpO1xuICB9KTtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRNdWx0aXBsZVNpYmxpbmdzRWxlbWVudHMgPSAoXG4gIGlkZW50aWZpZXJzOiBFbGVtZW50SWRlbnRpZmllcltdW10sXG4gIGlnbm9yZUNsYXNzTmFtZXM6IHN0cmluZ1tdID0gW10sXG4gIGRvY3VtZW50OiBEb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudFxuKTogKEVsZW1lbnQgfCB1bmRlZmluZWQpW11bXSA9PiB7XG4gIGlmIChpZGVudGlmaWVycy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBpZiAoaWRlbnRpZmllcnMubGVuZ3RoID09PSAxKSB7XG4gICAgY29uc3QgcmVzdWx0ID0gZ2V0U2libGluZ3NFbGVtZW50cyhcbiAgICAgIGlkZW50aWZpZXJzWzBdLFxuICAgICAgaWdub3JlQ2xhc3NOYW1lcyxcbiAgICAgIGRvY3VtZW50XG4gICAgKTtcbiAgICByZXR1cm4gW3Jlc3VsdF07XG4gIH1cblxuICBjb25zdCBhbmNlc3RvclhQYXRoID0gdG9BbmNlc3RvclhQYXRoKGlkZW50aWZpZXJzKTtcbiAgY29uc3QgYW5jZXN0b3JFbGVtZW50cyA9IGV2YWx1YXRlWFBhdGgoYW5jZXN0b3JYUGF0aCwgZG9jdW1lbnQsIGRvY3VtZW50KTtcblxuICBjb25zdCBlbGVtZW50c0FycmF5ID0gaWRlbnRpZmllcnMubWFwKChpZGVudGlmaWVyKSA9PiB7XG4gICAgcmV0dXJuIGdldFNpYmxpbmdzRWxlbWVudHMoaWRlbnRpZmllciwgaWdub3JlQ2xhc3NOYW1lcywgZG9jdW1lbnQpO1xuICB9KTtcblxuICBjb25zdCBtYXhMZW5ndGggPSBlbGVtZW50c0FycmF5LnJlZHVjZSgoYWNjLCBjdXJyZW50KSA9PiB7XG4gICAgcmV0dXJuIGN1cnJlbnQubGVuZ3RoID4gYWNjID8gY3VycmVudC5sZW5ndGggOiBhY2M7XG4gIH0sIDApO1xuXG4gIGlmIChhbmNlc3RvckVsZW1lbnRzLmxlbmd0aCA9PT0gbWF4TGVuZ3RoKSB7XG4gICAgY29uc3QgZ3JvdXBlZCA9IGFuY2VzdG9yRWxlbWVudHMubWFwKChhbmNlc3RvcikgPT4ge1xuICAgICAgcmV0dXJuIGVsZW1lbnRzQXJyYXkubWFwKChlbGVtZW50cykgPT4ge1xuICAgICAgICByZXR1cm4gZWxlbWVudHMuZmluZChcbiAgICAgICAgICAoZSkgPT5cbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxuICAgICAgICAgICAgYW5jZXN0b3IuY29tcGFyZURvY3VtZW50UG9zaXRpb24oZSkgJiAxNiAvL05vZGUuRE9DVU1FTlRfUE9TSVRJT05fQ09OVEFJTkVEX0JZXG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gXy56aXAoLi4uZ3JvdXBlZCk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGVsZW1lbnRzQXJyYXk7XG4gIH1cbn07XG5cbmNvbnN0IGlzTWF0Y2hlZEF0dHJpYnV0ZXMgPSAoXG4gIGVsZW1lbnQ6IEVsZW1lbnQsXG4gIGZyYWdtZW50OiBFbGVtZW50RnJhZ21lbnQsXG4gIGlnbm9yZUNsYXNzTmFtZXM6IHN0cmluZ1tdXG4pOiBib29sZWFuID0+IHtcbiAgcmV0dXJuIChcbiAgICBpc01hdGNoZWRJZChlbGVtZW50LCBmcmFnbWVudCkgJiZcbiAgICBpc01hdGNoZWRDbGFzc05hbWVzKGVsZW1lbnQsIGZyYWdtZW50LCBpZ25vcmVDbGFzc05hbWVzKSAmJlxuICAgIGlzTWF0Y2hlZFJvbGVzKGVsZW1lbnQsIGZyYWdtZW50KVxuICApO1xufTtcblxuY29uc3QgaXNNYXRjaGVkSWQgPSAoZWxlbWVudDogRWxlbWVudCwgZnJhZ21lbnQ6IEVsZW1lbnRGcmFnbWVudCk6IGJvb2xlYW4gPT4ge1xuICBjb25zdCBpZCA9IGVsZW1lbnQuaWQubGVuZ3RoID4gMCA/IGVsZW1lbnQuaWQgOiB1bmRlZmluZWQ7XG4gIHJldHVybiBmcmFnbWVudC5pZCA9PT0gaWQ7XG59O1xuXG5jb25zdCBpc01hdGNoZWRDbGFzc05hbWVzID0gKFxuICBlbGVtZW50OiBFbGVtZW50LFxuICBmcmFnbWVudDogRWxlbWVudEZyYWdtZW50LFxuICBpZ25vcmVDbGFzc05hbWVzOiBzdHJpbmdbXVxuKTogYm9vbGVhbiA9PiB7XG4gIGNvbnN0IGNsYXNzTmFtZXMgPSBBcnJheS5mcm9tKGVsZW1lbnQuY2xhc3NMaXN0KS5maWx0ZXIoXG4gICAgKGNuKSA9PiAhaWdub3JlQ2xhc3NOYW1lcy5pbmNsdWRlcyhjbilcbiAgKTtcblxuICBpZiAoZnJhZ21lbnQuY2xhc3NOYW1lcy5sZW5ndGggPT09IDAgJiYgY2xhc3NOYW1lcy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGNvbnN0IGludGVyc2VjdGVkID0gXy5pbnRlcnNlY3Rpb24oZnJhZ21lbnQuY2xhc3NOYW1lcywgY2xhc3NOYW1lcyk7XG4gIHJldHVybiBpbnRlcnNlY3RlZC5sZW5ndGggPiAwO1xufTtcblxuY29uc3QgaXNNYXRjaGVkUm9sZXMgPSAoXG4gIGVsZW1lbnQ6IEVsZW1lbnQsXG4gIGZyYWdtZW50OiBFbGVtZW50RnJhZ21lbnRcbik6IGJvb2xlYW4gPT4ge1xuICBjb25zdCByb2xlU3RyaW5nID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3JvbGUnKTtcbiAgY29uc3Qgcm9sZXMgPSByb2xlU3RyaW5nID8gcm9sZVN0cmluZy5zcGxpdCgnICcpIDogW107XG4gIGlmIChmcmFnbWVudC5yb2xlcy5sZW5ndGggPT09IDAgJiYgcm9sZXMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBjb25zdCBpbnRlcnNlY3RlZCA9IF8uaW50ZXJzZWN0aW9uKGZyYWdtZW50LnJvbGVzLCByb2xlcyk7XG4gIHJldHVybiBpbnRlcnNlY3RlZC5sZW5ndGggPiAwO1xufTtcblxuZXhwb3J0IGNvbnN0IGV2YWx1YXRlWFBhdGggPSAoXG4gIHhwYXRoOiBzdHJpbmcsXG4gIHJvb3Q6IE5vZGUgPSB3aW5kb3cuZG9jdW1lbnQsXG4gIGRvY3VtZW50OiBEb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudFxuKTogRWxlbWVudFtdID0+IHtcbiAgY29uc3QgcmVzdWx0ID0gZG9jdW1lbnQuZXZhbHVhdGUoXG4gICAgcm9vdCA9PT0gZG9jdW1lbnQgJiYgIS9eXFwuLy50ZXN0KHhwYXRoKSA/IHhwYXRoIDogYC4ke3hwYXRofWAsXG4gICAgcm9vdCxcbiAgICBudWxsLFxuICAgIDcsIC8vIFhQYXRoUmVzdWx0Lk9SREVSRURfTk9ERV9TTkFQU0hPVF9UWVBFLFxuICAgIG51bGxcbiAgKTtcblxuICBjb25zdCBlbGVtZW50czogRWxlbWVudFtdID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgcmVzdWx0LnNuYXBzaG90TGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCBub2RlID0gcmVzdWx0LnNuYXBzaG90SXRlbShpKTtcbiAgICBpZiAobm9kZSAmJiBub2RlLm5vZGVUeXBlID09PSAxKSB7XG4gICAgICAvLyBOb2RlLkVMRU1FTlRfTk9ERVxuICAgICAgZWxlbWVudHMucHVzaChub2RlIGFzIEVsZW1lbnQpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBlbGVtZW50cztcbn07XG4iXX0=