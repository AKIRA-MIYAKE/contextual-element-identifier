"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.evaluateXPath = exports.getMultipleSiblingsElements = exports.getSiblingsElements = exports.findElementsWithPredicate = exports.findElements = exports.getElement = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _xpath = require("../xpath");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

var getElement = function getElement(identifier) {
  var ignoreClassNames = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;

  var last = _lodash.default.last(identifier.absolute);

  if (!last) {
    return undefined;
  }

  var xpath = (0, _xpath.toAbsoluteXPath)(identifier);
  var result = evaluateXPath(xpath, document, document);

  if (result.length === 1 && isMatchedAttributes(result[0], last, ignoreClassNames)) {
    return result[0];
  } else {
    return undefined;
  }
};

exports.getElement = getElement;

var findElements = function findElements(identifier) {
  var ignoreClassNames = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;

  var last = _lodash.default.last(identifier.absolute);

  if (!last) {
    return [];
  }

  var strictElement = getElement(identifier, ignoreClassNames, document);

  if (strictElement) {
    return [strictElement];
  }

  var uniqueXPath = (0, _xpath.toUniqueXPath)(identifier);
  var uniqueResult = evaluateXPath(uniqueXPath, document, document);
  var uniqueMatched = uniqueResult.filter(function (e) {
    return isMatchedAttributes(e, last, ignoreClassNames);
  });

  if (uniqueMatched.length === 1) {
    return uniqueMatched;
  }

  var elements = [];
  var fragments = [];

  for (var i = 0; i < identifier.absolute.length; i++) {
    var fragment = identifier.absolute[identifier.absolute.length - 1 - i];
    fragments = [fragment].concat(_toConsumableArray(fragments));
    var xpath = (0, _xpath.greedyXPathFromFragments)(fragments);
    var elems = evaluateXPath(xpath, document, document);
    var matched = elems.filter(function (e) {
      return isMatchedAttributes(e, last, ignoreClassNames);
    });

    if (matched.length === 1) {
      elements = matched;
      break;
    } else if (matched.length > 1) {
      elements = matched;
    }
  }

  return elements;
};

exports.findElements = findElements;

var findElementsWithPredicate = function findElementsWithPredicate(identifier, predicate) {
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;

  var last = _lodash.default.last(identifier.absolute);

  if (!last) {
    return [];
  }

  var uniqueXPath = (0, _xpath.toUniqueXPath)(identifier);
  var uniqueResult = evaluateXPath(uniqueXPath, document, document);
  var uniqueMatched = uniqueResult.filter(predicate);

  if (uniqueMatched.length === 1) {
    return uniqueMatched;
  }

  var elements = [];
  var fragments = [];

  for (var i = 0; i < identifier.absolute.length; i++) {
    var fragment = identifier.absolute[identifier.absolute.length - 1 - i];
    fragments = [fragment].concat(_toConsumableArray(fragments));
    var xpath = (0, _xpath.greedyXPathFromFragments)(fragments);
    var elems = evaluateXPath(xpath, document, document);
    var matched = elems.filter(predicate);

    if (matched.length === 1) {
      elements = matched;
      break;
    } else if (matched.length > 1) {
      elements = matched;
    }
  }

  return elements;
};

exports.findElementsWithPredicate = findElementsWithPredicate;

var getSiblingsElements = function getSiblingsElements(identifier) {
  var ignoreClassNames = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;
  var identifiers = !Array.isArray(identifier) ? [identifier] : identifier;
  var lasts = identifiers.map(function (i) {
    return _lodash.default.last(i.absolute);
  }).filter(function (f) {
    return typeof f !== 'undefined';
  });

  if (lasts.length === 0) {
    return [];
  }

  var xpath = (0, _xpath.toSiblingsXPath)(identifier);
  var elements = evaluateXPath(xpath, document, document);
  return elements.filter(function (e) {
    return lasts.some(function (f) {
      return isMatchedAttributes(e, f, ignoreClassNames);
    });
  });
};

exports.getSiblingsElements = getSiblingsElements;

var getMultipleSiblingsElements = function getMultipleSiblingsElements(identifiers) {
  var ignoreClassNames = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;

  if (identifiers.length === 0) {
    return [];
  }

  if (identifiers.length === 1) {
    var result = getSiblingsElements(identifiers[0], ignoreClassNames, document);
    return [result];
  }

  var ancestorXPath = (0, _xpath.toAncestorXPath)(identifiers);
  var ancestorElements = evaluateXPath(ancestorXPath, document, document);
  var elementsArray = identifiers.map(function (identifier) {
    return getSiblingsElements(identifier, ignoreClassNames, document);
  });
  var maxLength = elementsArray.reduce(function (acc, current) {
    return current.length > acc ? current.length : acc;
  }, 0);

  if (ancestorElements.length === maxLength) {
    var grouped = ancestorElements.map(function (ancestor) {
      return elementsArray.map(function (elements) {
        return elements.find(function (e) {
          return (// tslint:disable-next-line
            ancestor.compareDocumentPosition(e) & 16
          );
        } //Node.DOCUMENT_POSITION_CONTAINED_BY
        );
      });
    });
    return _lodash.default.zip.apply(_lodash.default, _toConsumableArray(grouped));
  } else {
    return elementsArray;
  }
};

exports.getMultipleSiblingsElements = getMultipleSiblingsElements;

var isMatchedAttributes = function isMatchedAttributes(element, fragment, ignoreClassNames) {
  return isMatchedId(element, fragment) && isMatchedClassNames(element, fragment, ignoreClassNames) && isMatchedRoles(element, fragment);
};

var isMatchedId = function isMatchedId(element, fragment) {
  var id = element.id.length > 0 ? element.id : undefined;
  return fragment.id === id;
};

var isMatchedClassNames = function isMatchedClassNames(element, fragment, ignoreClassNames) {
  var classNames = Array.from(element.classList).filter(function (cn) {
    return !ignoreClassNames.includes(cn);
  });

  if (fragment.classNames.length === 0 && classNames.length === 0) {
    return true;
  }

  var intersected = _lodash.default.intersection(fragment.classNames, classNames);

  return intersected.length > 0;
};

var isMatchedRoles = function isMatchedRoles(element, fragment) {
  var roleString = element.getAttribute('role');
  var roles = roleString ? roleString.split(' ') : [];

  if (fragment.roles.length === 0 && roles.length === 0) {
    return true;
  }

  var intersected = _lodash.default.intersection(fragment.roles, roles);

  return intersected.length > 0;
};

var evaluateXPath = function evaluateXPath(xpath) {
  var root = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : window.document;
  var document = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : window.document;
  var result = document.evaluate(root === document && !/^\./.test(xpath) ? xpath : ".".concat(xpath), root, null, 7, // XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,
  null);
  var elements = [];

  for (var i = 0; i < result.snapshotLength; i++) {
    var node = result.snapshotItem(i);

    if (node && node.nodeType === 1) {
      // Node.ELEMENT_NODE
      elements.push(node);
    }
  }

  return elements;
};

exports.evaluateXPath = evaluateXPath;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9maW5kZXIvaW5kZXgudHMiXSwibmFtZXMiOlsiZ2V0RWxlbWVudCIsImlkZW50aWZpZXIiLCJpZ25vcmVDbGFzc05hbWVzIiwiZG9jdW1lbnQiLCJ3aW5kb3ciLCJsYXN0IiwiXyIsImFic29sdXRlIiwidW5kZWZpbmVkIiwieHBhdGgiLCJyZXN1bHQiLCJldmFsdWF0ZVhQYXRoIiwibGVuZ3RoIiwiaXNNYXRjaGVkQXR0cmlidXRlcyIsImZpbmRFbGVtZW50cyIsInN0cmljdEVsZW1lbnQiLCJ1bmlxdWVYUGF0aCIsInVuaXF1ZVJlc3VsdCIsInVuaXF1ZU1hdGNoZWQiLCJmaWx0ZXIiLCJlIiwiZWxlbWVudHMiLCJmcmFnbWVudHMiLCJpIiwiZnJhZ21lbnQiLCJlbGVtcyIsIm1hdGNoZWQiLCJmaW5kRWxlbWVudHNXaXRoUHJlZGljYXRlIiwicHJlZGljYXRlIiwiZ2V0U2libGluZ3NFbGVtZW50cyIsImlkZW50aWZpZXJzIiwiQXJyYXkiLCJpc0FycmF5IiwibGFzdHMiLCJtYXAiLCJmIiwic29tZSIsImdldE11bHRpcGxlU2libGluZ3NFbGVtZW50cyIsImFuY2VzdG9yWFBhdGgiLCJhbmNlc3RvckVsZW1lbnRzIiwiZWxlbWVudHNBcnJheSIsIm1heExlbmd0aCIsInJlZHVjZSIsImFjYyIsImN1cnJlbnQiLCJncm91cGVkIiwiYW5jZXN0b3IiLCJmaW5kIiwiY29tcGFyZURvY3VtZW50UG9zaXRpb24iLCJ6aXAiLCJlbGVtZW50IiwiaXNNYXRjaGVkSWQiLCJpc01hdGNoZWRDbGFzc05hbWVzIiwiaXNNYXRjaGVkUm9sZXMiLCJpZCIsImNsYXNzTmFtZXMiLCJmcm9tIiwiY2xhc3NMaXN0IiwiY24iLCJpbmNsdWRlcyIsImludGVyc2VjdGVkIiwiaW50ZXJzZWN0aW9uIiwicm9sZVN0cmluZyIsImdldEF0dHJpYnV0ZSIsInJvbGVzIiwic3BsaXQiLCJyb290IiwiZXZhbHVhdGUiLCJ0ZXN0Iiwic25hcHNob3RMZW5ndGgiLCJu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Q0FuRCxNQUFBQSxRQUFRLENBQUNvRCxJQUFULENBQWNILElBQWQ7QUFDRDtBQUNGOztBQUVELFNBQU9qRCxRQUFQO0FBQ0QsQ0F2Qk0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5pbXBvcnQgeyBFbGVtZW50SWRlbnRpZmllciwgRWxlbWVudEZyYWdtZW50IH0gZnJvbSAnLi4vaWRlbnRpZmllci9pbnRlcmZhY2VzJztcbmltcG9ydCB7XG4gIHRvQWJzb2x1dGVYUGF0aCxcbiAgdG9VbmlxdWVYUGF0aCxcbiAgdG9TaWJsaW5nc1hQYXRoLFxuICB0b0FuY2VzdG9yWFBhdGgsXG4gIGdyZWVkeVhQYXRoRnJvbUZyYWdtZW50cyxcbn0gZnJvbSAnLi4veHBhdGgnO1xuXG5leHBvcnQgY29uc3QgZ2V0RWxlbWVudCA9IChcbiAgaWRlbnRpZmllcjogRWxlbWVudElkZW50aWZpZXIsXG4gIGlnbm9yZUNsYXNzTmFtZXM6IHN0cmluZ1tdID0gW10sXG4gIGRvY3VtZW50OiBEb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudFxuKTogRWxlbWVudCB8IHVuZGVmaW5lZCA9PiB7XG4gIGNvbnN0IGxhc3QgPSBfLmxhc3QoaWRlbnRpZmllci5hYnNvbHV0ZSk7XG4gIGlmICghbGFzdCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCB4cGF0aCA9IHRvQWJzb2x1dGVYUGF0aChpZGVudGlmaWVyKTtcbiAgY29uc3QgcmVzdWx0ID0gZXZhbHVhdGVYUGF0aCh4cGF0aCwgZG9jdW1lbnQsIGRvY3VtZW50KTtcblxuICBpZiAoXG4gICAgcmVzdWx0Lmxlbmd0aCA9PT0gMSAmJlxuICAgIGlzTWF0Y2hlZEF0dHJpYnV0ZXMocmVzdWx0WzBdLCBsYXN0LCBpZ25vcmVDbGFzc05hbWVzKVxuICApIHtcbiAgICByZXR1cm4gcmVzdWx0WzBdO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBmaW5kRWxlbWVudHMgPSAoXG4gIGlkZW50aWZpZXI6IEVsZW1lbnRJZGVudGlmaWVyLFxuICBpZ25vcmVDbGFzc05hbWVzOiBzdHJpbmdbXSA9IFtdLFxuICBkb2N1bWVudDogRG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnRcbik6IEVsZW1lbnRbXSA9PiB7XG4gIGNvbnN0IGxhc3QgPSBfLmxhc3QoaWRlbnRpZmllci5hYnNvbHV0ZSk7XG4gIGlmICghbGFzdCkge1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIGNvbnN0IHN0cmljdEVsZW1lbnQgPSBnZXRFbGVtZW50KGlkZW50aWZpZXIsIGlnbm9yZUNsYXNzTmFtZXMsIGRvY3VtZW50KTtcbiAgaWYgKHN0cmljdEVsZW1lbnQpIHtcbiAgICByZXR1cm4gW3N0cmljdEVsZW1lbnRdO1xuICB9XG5cbiAgY29uc3QgdW5pcXVlWFBhdGggPSB0b1VuaXF1ZVhQYXRoKGlkZW50aWZpZXIpO1xuICBjb25zdCB1bmlxdWVSZXN1bHQgPSBldmFsdWF0ZVhQYXRoKHVuaXF1ZVhQYXRoLCBkb2N1bWVudCwgZG9jdW1lbnQpO1xuICBjb25zdCB1bmlxdWVNYXRjaGVkID0gdW5pcXVlUmVzdWx0LmZpbHRlcihlID0+XG4gICAgaXNNYXRjaGVkQXR0cmlidXRlcyhlLCBsYXN0LCBpZ25vcmVDbGFzc05hbWVzKVxuICApO1xuICBpZiAodW5pcXVlTWF0Y2hlZC5sZW5ndGggPT09IDEpIHtcbiAgICByZXR1cm4gdW5pcXVlTWF0Y2hlZDtcbiAgfVxuXG4gIGxldCBlbGVtZW50czogRWxlbWVudFtdID0gW107XG4gIGxldCBmcmFnbWVudHM6IEVsZW1lbnRGcmFnbWVudFtdID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgaWRlbnRpZmllci5hYnNvbHV0ZS5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IGZyYWdtZW50ID0gaWRlbnRpZmllci5hYnNvbHV0ZVtpZGVudGlmaWVyLmFic29sdXRlLmxlbmd0aCAtIDEgLSBpXTtcbiAgICBmcmFnbWVudHMgPSBbZnJhZ21lbnQsIC4uLmZyYWdtZW50c107XG4gICAgY29uc3QgeHBhdGggPSBncmVlZHlYUGF0aEZyb21GcmFnbWVudHMoZnJhZ21lbnRzKTtcbiAgICBjb25zdCBlbGVtcyA9IGV2YWx1YXRlWFBhdGgoeHBhdGgsIGRvY3VtZW50LCBkb2N1bWVudCk7XG4gICAgY29uc3QgbWF0Y2hlZCA9IGVsZW1zLmZpbHRlcihlID0+XG4gICAgICBpc01hdGNoZWRBdHRyaWJ1dGVzKGUsIGxhc3QsIGlnbm9yZUNsYXNzTmFtZXMpXG4gICAgKTtcbiAgICBpZiAobWF0Y2hlZC5sZW5ndGggPT09IDEpIHtcbiAgICAgIGVsZW1lbnRzID0gbWF0Y2hlZDtcbiAgICAgIGJyZWFrO1xuICAgIH0gZWxzZSBpZiAobWF0Y2hlZC5sZW5ndGggPiAxKSB7XG4gICAgICBlbGVtZW50cyA9IG1hdGNoZWQ7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGVsZW1lbnRzO1xufTtcblxuZXhwb3J0IGNvbnN0IGZpbmRFbGVtZW50c1dpdGhQcmVkaWNhdGUgPSAoXG4gIGlkZW50aWZpZXI6IEVsZW1lbnRJZGVudGlmaWVyLFxuICBwcmVkaWNhdGU6IChlbGVtZW50OiBFbGVtZW50KSA9PiBib29sZWFuLFxuICBkb2N1bWVudDogRG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnRcbik6IEVsZW1lbnRbXSA9PiB7XG4gIGNvbnN0IGxhc3QgPSBfLmxhc3QoaWRlbnRpZmllci5hYnNvbHV0ZSk7XG4gIGlmICghbGFzdCkge1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIGNvbnN0IHVuaXF1ZVhQYXRoID0gdG9VbmlxdWVYUGF0aChpZGVudGlmaWVyKTtcbiAgY29uc3QgdW5pcXVlUmVzdWx0ID0gZXZhbHVhdGVYUGF0aCh1bmlxdWVYUGF0aCwgZG9jdW1lbnQsIGRvY3VtZW50KTtcbiAgY29uc3QgdW5pcXVlTWF0Y2hlZCA9IHVuaXF1ZVJlc3VsdC5maWx0ZXIocHJlZGljYXRlKTtcbiAgaWYgKHVuaXF1ZU1hdGNoZWQubGVuZ3RoID09PSAxKSB7XG4gICAgcmV0dXJuIHVuaXF1ZU1hdGNoZWQ7XG4gIH1cblxuICBsZXQgZWxlbWVudHM6IEVsZW1lbnRbXSA9IFtdO1xuICBsZXQgZnJhZ21lbnRzOiBFbGVtZW50RnJhZ21lbnRbXSA9IFtdO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGlkZW50aWZpZXIuYWJzb2x1dGUubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCBmcmFnbWVudCA9IGlkZW50aWZpZXIuYWJzb2x1dGVbaWRlbnRpZmllci5hYnNvbHV0ZS5sZW5ndGggLSAxIC0gaV07XG4gICAgZnJhZ21lbnRzID0gW2ZyYWdtZW50LCAuLi5mcmFnbWVudHNdO1xuICAgIGNvbnN0IHhwYXRoID0gZ3JlZWR5WFBhdGhGcm9tRnJhZ21lbnRzKGZyYWdtZW50cyk7XG4gICAgY29uc3QgZWxlbXMgPSBldmFsdWF0ZVhQYXRoKHhwYXRoLCBkb2N1bWVudCwgZG9jdW1lbnQpO1xuICAgIGNvbnN0IG1hdGNoZWQgPSBlbGVtcy5maWx0ZXIocHJlZGljYXRlKTtcbiAgICBpZiAobWF0Y2hlZC5sZW5ndGggPT09IDEpIHtcbiAgICAgIGVsZW1lbnRzID0gbWF0Y2hlZDtcbiAgICAgIGJyZWFrO1xuICAgIH0gZWxzZSBpZiAobWF0Y2hlZC5sZW5ndGggPiAxKSB7XG4gICAgICBlbGVtZW50cyA9IG1hdGNoZWQ7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGVsZW1lbnRzO1xufTtcblxuZXhwb3J0IGNvbnN0IGdldFNpYmxpbmdzRWxlbWVudHMgPSAoXG4gIGlkZW50aWZpZXI6IEVsZW1lbnRJZGVudGlmaWVyIHwgRWxlbWVudElkZW50aWZpZXJbXSxcbiAgaWdub3JlQ2xhc3NOYW1lczogc3RyaW5nW10gPSBbXSxcbiAgZG9jdW1lbnQ6IERvY3VtZW50ID0gd2luZG93LmRvY3VtZW50XG4pOiBFbGVtZW50W10gPT4ge1xuICBjb25zdCBpZGVudGlmaWVycyA9ICFBcnJheS5pc0FycmF5KGlkZW50aWZpZXIpID8gW2lkZW50aWZpZXJdIDogaWRlbnRpZmllcjtcbiAgY29uc3QgbGFzdHMgPSBpZGVudGlmaWVyc1xuICAgIC5tYXAoaSA9PiBfLmxhc3QoaS5hYnNvbHV0ZSkpXG4gICAgLmZpbHRlcihmID0+IHR5cGVvZiBmICE9PSAndW5kZWZpbmVkJykgYXMgRWxlbWVudEZyYWdtZW50W107XG5cbiAgaWYgKGxhc3RzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIGNvbnN0IHhwYXRoID0gdG9TaWJsaW5nc1hQYXRoKGlkZW50aWZpZXIpO1xuICBjb25zdCBlbGVtZW50cyA9IGV2YWx1YXRlWFBhdGgoeHBhdGgsIGRvY3VtZW50LCBkb2N1bWVudCk7XG5cbiAgcmV0dXJuIGVsZW1lbnRzLmZpbHRlcihlID0+IHtcbiAgICByZXR1cm4gbGFzdHMuc29tZShmID0+IGlzTWF0Y2hlZEF0dHJpYnV0ZXMoZSwgZiwgaWdub3JlQ2xhc3NOYW1lcykpO1xuICB9KTtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRNdWx0aXBsZVNpYmxpbmdzRWxlbWVudHMgPSAoXG4gIGlkZW50aWZpZXJzOiBFbGVtZW50SWRlbnRpZmllcltdW10sXG4gIGlnbm9yZUNsYXNzTmFtZXM6IHN0cmluZ1tdID0gW10sXG4gIGRvY3VtZW50OiBEb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudFxuKTogKEVsZW1lbnQgfCB1bmRlZmluZWQpW11bXSA9PiB7XG4gIGlmIChpZGVudGlmaWVycy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBpZiAoaWRlbnRpZmllcnMubGVuZ3RoID09PSAxKSB7XG4gICAgY29uc3QgcmVzdWx0ID0gZ2V0U2libGluZ3NFbGVtZW50cyhcbiAgICAgIGlkZW50aWZpZXJzWzBdLFxuICAgICAgaWdub3JlQ2xhc3NOYW1lcyxcbiAgICAgIGRvY3VtZW50XG4gICAgKTtcbiAgICByZXR1cm4gW3Jlc3VsdF07XG4gIH1cblxuICBjb25zdCBhbmNlc3RvclhQYXRoID0gdG9BbmNlc3RvclhQYXRoKGlkZW50aWZpZXJzKTtcbiAgY29uc3QgYW5jZXN0b3JFbGVtZW50cyA9IGV2YWx1YXRlWFBhdGgoYW5jZXN0b3JYUGF0aCwgZG9jdW1lbnQsIGRvY3VtZW50KTtcblxuICBjb25zdCBlbGVtZW50c0FycmF5ID0gaWRlbnRpZmllcnMubWFwKGlkZW50aWZpZXIgPT4ge1xuICAgIHJldHVybiBnZXRTaWJsaW5nc0VsZW1lbnRzKGlkZW50aWZpZXIsIGlnbm9yZUNsYXNzTmFtZXMsIGRvY3VtZW50KTtcbiAgfSk7XG5cbiAgY29uc3QgbWF4TGVuZ3RoID0gZWxlbWVudHNBcnJheS5yZWR1Y2UoKGFjYywgY3VycmVudCkgPT4ge1xuICAgIHJldHVybiBjdXJyZW50Lmxlbmd0aCA+IGFjYyA/IGN1cnJlbnQubGVuZ3RoIDogYWNjO1xuICB9LCAwKTtcblxuICBpZiAoYW5jZXN0b3JFbGVtZW50cy5sZW5ndGggPT09IG1heExlbmd0aCkge1xuICAgIGNvbnN0IGdyb3VwZWQgPSBhbmNlc3RvckVsZW1lbnRzLm1hcChhbmNlc3RvciA9PiB7XG4gICAgICByZXR1cm4gZWxlbWVudHNBcnJheS5tYXAoZWxlbWVudHMgPT4ge1xuICAgICAgICByZXR1cm4gZWxlbWVudHMuZmluZChcbiAgICAgICAgICBlID0+XG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmVcbiAgICAgICAgICAgIGFuY2VzdG9yLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGUpICYgMTYgLy9Ob2RlLkRPQ1VNRU5UX1BPU0lUSU9OX0NPTlRBSU5FRF9CWVxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIF8uemlwKC4uLmdyb3VwZWQpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBlbGVtZW50c0FycmF5O1xuICB9XG59O1xuXG5jb25zdCBpc01hdGNoZWRBdHRyaWJ1dGVzID0gKFxuICBlbGVtZW50OiBFbGVtZW50LFxuICBmcmFnbWVudDogRWxlbWVudEZyYWdtZW50LFxuICBpZ25vcmVDbGFzc05hbWVzOiBzdHJpbmdbXVxuKTogYm9vbGVhbiA9PiB7XG4gIHJldHVybiAoXG4gICAgaXNNYXRjaGVkSWQoZWxlbWVudCwgZnJhZ21lbnQpICYmXG4gICAgaXNNYXRjaGVkQ2xhc3NOYW1lcyhlbGVtZW50LCBmcmFnbWVudCwgaWdub3JlQ2xhc3NOYW1lcykgJiZcbiAgICBpc01hdGNoZWRSb2xlcyhlbGVtZW50LCBmcmFnbWVudClcbiAgKTtcbn07XG5cbmNvbnN0IGlzTWF0Y2hlZElkID0gKGVsZW1lbnQ6IEVsZW1lbnQsIGZyYWdtZW50OiBFbGVtZW50RnJhZ21lbnQpOiBib29sZWFuID0+IHtcbiAgY29uc3QgaWQgPSBlbGVtZW50LmlkLmxlbmd0aCA+IDAgPyBlbGVtZW50LmlkIDogdW5kZWZpbmVkO1xuICByZXR1cm4gZnJhZ21lbnQuaWQgPT09IGlkO1xufTtcblxuY29uc3QgaXNNYXRjaGVkQ2xhc3NOYW1lcyA9IChcbiAgZWxlbWVudDogRWxlbWVudCxcbiAgZnJhZ21lbnQ6IEVsZW1lbnRGcmFnbWVudCxcbiAgaWdub3JlQ2xhc3NOYW1lczogc3RyaW5nW11cbik6IGJvb2xlYW4gPT4ge1xuICBjb25zdCBjbGFzc05hbWVzID0gQXJyYXkuZnJvbShlbGVtZW50LmNsYXNzTGlzdCkuZmlsdGVyKFxuICAgIGNuID0+ICFpZ25vcmVDbGFzc05hbWVzLmluY2x1ZGVzKGNuKVxuICApO1xuXG4gIGlmIChmcmFnbWVudC5jbGFzc05hbWVzLmxlbmd0aCA9PT0gMCAmJiBjbGFzc05hbWVzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgY29uc3QgaW50ZXJzZWN0ZWQgPSBfLmludGVyc2VjdGlvbihmcmFnbWVudC5jbGFzc05hbWVzLCBjbGFzc05hbWVzKTtcbiAgcmV0dXJuIGludGVyc2VjdGVkLmxlbmd0aCA+IDA7XG59O1xuXG5jb25zdCBpc01hdGNoZWRSb2xlcyA9IChcbiAgZWxlbWVudDogRWxlbWVudCxcbiAgZnJhZ21lbnQ6IEVsZW1lbnRGcmFnbWVudFxuKTogYm9vbGVhbiA9PiB7XG4gIGNvbnN0IHJvbGVTdHJpbmcgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgncm9sZScpO1xuICBjb25zdCByb2xlcyA9IHJvbGVTdHJpbmcgPyByb2xlU3RyaW5nLnNwbGl0KCcgJykgOiBbXTtcbiAgaWYgKGZyYWdtZW50LnJvbGVzLmxlbmd0aCA9PT0gMCAmJiByb2xlcy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGNvbnN0IGludGVyc2VjdGVkID0gXy5pbnRlcnNlY3Rpb24oZnJhZ21lbnQucm9sZXMsIHJvbGVzKTtcbiAgcmV0dXJuIGludGVyc2VjdGVkLmxlbmd0aCA+IDA7XG59O1xuXG5leHBvcnQgY29uc3QgZXZhbHVhdGVYUGF0aCA9IChcbiAgeHBhdGg6IHN0cmluZyxcbiAgcm9vdDogTm9kZSA9IHdpbmRvdy5kb2N1bWVudCxcbiAgZG9jdW1lbnQ6IERvY3VtZW50ID0gd2luZG93LmRvY3VtZW50XG4pOiBFbGVtZW50W10gPT4ge1xuICBjb25zdCByZXN1bHQgPSBkb2N1bWVudC5ldmFsdWF0ZShcbiAgICByb290ID09PSBkb2N1bWVudCAmJiAhL15cXC4vLnRlc3QoeHBhdGgpID8geHBhdGggOiBgLiR7eHBhdGh9YCxcbiAgICByb290LFxuICAgIG51bGwsXG4gICAgNywgLy8gWFBhdGhSZXN1bHQuT1JERVJFRF9OT0RFX1NOQVBTSE9UX1RZUEUsXG4gICAgbnVsbFxuICApO1xuXG4gIGNvbnN0IGVsZW1lbnRzOiBFbGVtZW50W10gPSBbXTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHQuc25hcHNob3RMZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IG5vZGUgPSByZXN1bHQuc25hcHNob3RJdGVtKGkpO1xuICAgIGlmIChub2RlICYmIG5vZGUubm9kZVR5cGUgPT09IDEpIHtcbiAgICAgIC8vIE5vZGUuRUxFTUVOVF9OT0RFXG4gICAgICBlbGVtZW50cy5wdXNoKG5vZGUgYXMgRWxlbWVudCk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGVsZW1lbnRzO1xufTtcbiJdfQ==